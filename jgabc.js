String.prototype.repeat=function(b){return new Array(b+1).join(this)};gabcSettings={trimStaff:true};var _indicesChar={flat:[57585,58176,57586,58177,57587,58178,57588,58179,57589,58180,57590,58181,57591],natural:[57593,58182,57594,58183,57595,58184,57596,58185,57597,58186,57598,58187,57599],flat_line:58176,natural_line:58182,punctum:57603,diamond:57619,virga:57635,v:57635,leftVirga:57651,quilisma:57667,w:57667,bottomPartPodatus:57684,topPartPodatus:57699,podatus:[null,57715,57731,57748,57763],o:57779,O:57795,diamond_tilde:57811,">":57827,"<":57843,upper_tilde:57859,lower_tilde:57875,porrectus:[null,57891,57907,57923,57939],r:57971,s:57987,custos:58019,"+":58019,dot:58035,apos:58050,ictus:58050,ictus_above:58053,ictus_below:58050,underscore:58066,episema:58066,episema_below:58066,episema_above:58069,underscore_longer:58082,episema_longer:58082,clivis:[null,58115,58131,58147,58163],accent_above_staff:58188,connecting_line:[undefined,undefined,59139,59155,59171,59187],decorative_line:[undefined,59203,59219,59235,59251,59267]};var _indicesLig={flat:"b",natural:"a",punctum:"p",diamond:"n",virga:"v",v:"v",leftVirga:"c",quilisma:"q",w:"q",podatus:"P",bottomPartPodatus:57684,topPartPodatus:"P",o:"o",O:"O",diamond_tilde:"N",">":"L","<":"k",upper_tilde:"K",lower_tilde:"l",porrectus:"R",r:"w",s:"s",custos:"u","+":"u",dot:".",apos:"I",ictus:"I",ictus_above:"I",ictus_below:"i",underscore:"H",episema:"H",episema_above:"H",episema_below:"h",underscore_longer:58082,episema_longer:58082,clivis:"C",accent_above_staff:"~",connecting_line:"x",decorative_line:"X"};var _neumeLig=function(f,d){if(arguments.length<2){return""}if(typeof(f)!=="string"){if(arguments.length==2&&typeof(f)=="number"){return _neumeChar(f,d)}return""}var c="";var g=1;while(g<arguments.length){c+=_ci[arguments[g++]]}return c+f};var _neumeChar=function(d,c){if(arguments.length<2){return""}var f=d;var d,c;d=parseInt(c);c=0;if(typeof(f)=="object"){if(arguments.length>2){c=parseInt(arguments[2])}f=f[Math.abs(c-d)];if(arguments.length==2){d=0}}return String.fromCharCode(f+d)};var _clefSpanLig=function(f){var c=parseInt(f.clef.slice(-1),10);var d=c*2-1;var b="";if(f.clef.length==3){b+=neume(indices.flat,d+1)+"-"}return make("tspan",String(d)+(f.index==2?"d":"f")+"-"+b)};var _clefSpanChar=function(h,f){var b,d=parseInt(h.clef.slice(-1),10),c=0,g;if(h.index==2){g="d-";c=2-d}else{g="f-";c=3-d}if(h.clef.length==3){g+=neume(indices.flat,4)+"-"}c*=spaceheight;f[0]=Math.min(f[0],c);b=make("tspan",g);b.setAttribute("dy",c);return b};var _ci=["B","A","0","1","2","3","4","5","6","7","8","9","Z"];var staffheight=48;var spaceheight=staffheight/4;var notewidth=staffheight/6;var spaceBetweenNeumes=notewidth;var verticalSpace=staffheight/4;var fontsize=spaceheight*3/2;var spaceWidth=spaceheight*3/4;var staffoffset=Math.ceil(staffheight-spaceheight/2);var svgns="http://www.w3.org/2000/svg";var xlinkns="http://www.w3.org/1999/xlink";var staffInFont=false;var fontExt="ttf";var fontExtS="svg#webfont";var fontFormat="truetype";var fontFormatS="svg";var filenameCaeciliae="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExt;var filenameCaeciliaeS="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExtS;var filenameCaeciliaePrint="Caeciliae-"+(staffInFont?"Regular":"Staffless")+"-Print."+fontExt;var localCaeciliae="Caeciliae"+(staffInFont?"":" Staffless");var familyCaeciliae="Caeciliae"+(staffInFont?"":" Staffless");var styleCaeciliae="font-family: '"+familyCaeciliae+"'; font-size:"+staffheight+"px;";var styleCaeciliaeSvg="font-family: '"+familyCaeciliae+" SVG'; font-size:"+staffheight+"px;";var styleGoudy="font-family: 'OFL Sorts Mill Goudy TT'; font-size: "+fontsize+"px;";var styleFont="@font-face {font-family: '"+familyCaeciliae+"'; font-weight: normal; font-style: normal;src: local('"+localCaeciliae+"'); src: url('"+filenameCaeciliae+"') format('"+fontFormat+"')}@font-face {font-family: '"+familyCaeciliae+" SVG'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaeS+"') format('"+fontFormatS+"')}@font-face {font-family: '"+familyCaeciliae+" Print'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaePrint+"') format('"+fontFormat+"')}@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: italic; font-weight: normal; src: local('OFL Sorts Mill Goudy Italic TT'), local('OFLGoudyStMTT-Italic'), url('OFLGoudyStMTT-Italic.ttf') format('truetype');}@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: normal; font-weight: normal; src: local('OFL Sorts Mill Goudy TT'), local('OFLGoudyStMTT'), url('OFLGoudyStMTT.ttf') format('truetype');}";var svgWidth;var svg;var textElem;var codea="a".charCodeAt(0);var codem=codea+12;var codeA="A".charCodeAt(0);var codeM=codeA+12;var regexTranslate=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/;var regexTranslateG=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/g;var regexHeaderEnd=/(?:^|\n)%%\n/;var regexOuter=/((([^\(\r\n]+)($|\())|\()([^\)]*)($|\))(?:(\s+)|(?=(?:\([^\)]*\))+(\s*))|)/g;var regexTag=/<(\/)?(b|i|sc)>/i;var regexSqBrackets=/\[([^\]]*)(?:\]|$)/;var regexTags=/(<(b|i|sc)>)(.*?)(?:(<\/\1>)|$)/i;var regexTagsSp=/<sp>([^<]*)<\/sp>/gi;var spSubstitutions={"'ae":"ǽ","'æ":"ǽ",ae:"æ",oe:"œ","'œ":"œ","'oe":"œ",AE:"Æ",OE:"Œ",Ae:"Æ",Oe:"Œ","V/":"V","R/":"R","A/":"A"};String.prototype.replaceSpTags=function(){return this.replace(regexTagsSp,function(c){var b=c.slice(4,-5);return spSubstitutions[b]||b})};var regexInner=/(?:[!\/ ,;:`]+|[^\)!\/ ,;:`\[]+)(?:\[[^\]]*(?:$|\]))?/g;var rog={syl:3,gabc:5,whitespace:7};var linkSelector="";var linkDownloadSelector="";var setPdfLinkSelector=function(b){linkSelector=b};var onDragStart=function(b){console.info(b);b.originalEvent.dataTransfer.setData("DownloadURL",this.getAttribute("data-downloadurl"))};var setGabcLinkSelector=function(b){linkDownloadSelector=b;$(b).bind("dragstart",onDragStart)};var regexToneModifiers=/(')|(\.{1,2})|(_{1,4}0?)/g;var regexTones=new RegExp("([/ ,;:`]+)|((?:[fF]|[cC][bB]?)[1-4])|(?:(-)?(([A-M])|([a-m]))(([Vv]{1,3})|(s{1,3})|((<)|(>)|(~))|(w)|(o)|(O)|((x)|(y))|(q)|((R)|(r0)|(r(?![1-5])))|(r[1-5])|(\\+))?((?:"+String(regexToneModifiers).replace(/^\/|\/\w*$/g,"").replace(/\((?!\?:)/g,"(?:")+")*)|(z0))|\\[([^\\]]*)(?:\\]|$)","g");var regexTonesSpliceIndex=27;var regexToneModifiersCount=4;var rtg={whitespace:1,clef:2,initioDebilis:3,tone:4,toneUpper:5,toneLower:6,noteType:7,virga:8,stropha:9,liquescentia:10,ascendingLiquescentia:11,descendingLiquescentia:12,diminutiveLiquescentia:13,quilisma:14,oriscus:15,oriscusReverse:16,accidental:17,flat:18,natural:19,q:20,lineaPunctum:22,lineaPunctumCavum:23,punctumCavum:24,rNumber:25,custos:26,ictus:27,dot:28,episema:29,custos:30,bracketed:31};var regexVowel=/(?:[cgq]u|[iy])?([aeiouyáéëíóúýǽæœ]+)/i;var transforms=[["/"," ",",",";",":","`",""],["'","_","+",";","|",",",""],[/\//g,/ /g,/,/g,/;/g,/:/g,/`/g,/!/g]];var abcs={};var _defs=null;var defText=null;var _defText=null;var defChant=null;var masks=[];var selectedPunctum=-1;var selectedNeume=-1;var selectedPunctumTag=null;var selectedNeumeTag=null;var _timeoutGabcUpdate=null;var _minUpdateInterval=1700;var _heightCorrection=0;var _clefs=[];var _accidentals=[];var _tones=[];var utf8_bom=String.fromCharCode(239)+String.fromCharCode(187)+String.fromCharCode(191);function encode_utf8(b){return utf8_bom+unescape(encodeURIComponent(b))}function decode_utf8(b){return decodeURIComponent(escape(b))}function Header(g){this.comments=[];this.original="";var f=g.match(regexHeaderEnd);if(f){var d=this.original=g.slice(0,f.index+f[0].length);var c=d.split(/\r?\n/g);for(i in c){var b=c[i],f=regexHeaderLine.exec(b);if(f){this[f[1]]=f[2]}else{if((f=regexHeaderComment.exec(b))){if(b!="%%"){this.comments[i]=b}}}}}}Header.prototype.toString=function(){var b=[];for(key in this){if(key.length==0||key=="length"||key=="original"||key=="comments"||(typeof this[key])=="function"){continue}b.push(key+": "+this[key]+";")}for(i in this.comments){try{b.splice(i,0,this.comments[i])}catch(c){}}return b.join("\n")+"\n%%\n"};function getHeaderLen(c){var b=c.match(regexHeaderEnd);if(b){return b.index+b[0].length}else{return 0}}var regexHeaderLine=/^([\w-_]+):\s*([^;\r\n]+)(?:;|$)/i;var regexHeaderComment=/^%.*/;function getHeader(b){return new Header(b)}function updateLinks(g){var h=getHeader(g);if(h){g=g.slice(h.original.length)}else{h="%%\n"}if(linkSelector){$(linkSelector).attr("href","http://gregorio.gabrielmass.com/cgi/process.pl?gregtext="+window.escape(h+g)+"&gregfontselect=17&gregtextfontselect=12&greginitialselect=43&gregspaceselect=7mm&gregredselect=N&greglinethickselect=10&gregpaperselect=letterpaper&gregfaceselect=libertine&gregcropselect=N")}try{if(linkDownloadSelector){var d=encode_utf8(h+g);var c="data:text/plain;charset=utf8;base64,"+btoa(d);var b=h.name||"Untitled";if(!b.match(/\.gabc$/)){name+=".gabc"}$(linkDownloadSelector).attr("charset","UTF-8").attr("href",c).attr("data-downloadurl","text/plain:"+b+":"+c)}}catch(f){}return[h,g]}var gabcProcessTime=0;var _nextUpdate=new Date().getTime();function updateChant(k,f,g){if(!k){return}var l=updateLinks(k);if(_timeoutGabcUpdate){clearTimeout(_timeoutGabcUpdate)}if(!g){var d=gabcProcessTime+100;_timeoutGabcUpdate=setTimeout(function(){updateChant(k,f,true)},d);return}_nextUpdate=new Date().getTime()+100+gabcProcessTime;var b=new Date();k=l;_timeoutGabcUpdate=null;var c=$(f).find(">g")[0];if(!c){return}var h=[0];var j=getChant(k,f,c,h);f.setAttribute("height",j.getBBox().height+h[0]+_heightCorrection-_defText.getExtentOfChar("q").height);if(f.parentNode.tagName.match(/span/i)){$(f).css("width",j.getBBox().width)}gabcProcessTime=new Date()-b;console.info("Update chant time: "+gabcProcessTime);if(gabcProcessTime>3000){gabcProcessTime=3000}}function make(c,d){var b=document.createElementNS(svgns,c);if(d){b.appendChild(document.createTextNode(d))}return b}var _txtWidths={};function textWidth(d,n,h){var c=0;var g=undefined;if(d.length===0){return 0}if(typeof(n)=="number"&&typeof(h)=="number"){c=n;g=h;n=h=undefined;if(g===0){return 0}}var b=h?_defText:defText;if($.isArray(d)){var f;var k;if(d.length==1&&d[0].tags.length==0){d=d[0].text;if(n==undefined||n=="goudy"){n=""}if(c==0&&!g&&(k=n+","+d)&&(f=_txtWidths[k])){return f}}else{if(c==0&&!g&&(k=JSON.stringify(d))&&(f=_txtWidths[k])){return f}$(b).empty();var o=0;var j=0;d.forEach(function(t){var r=t.span();b.appendChild(r);var s=Math.max(c,j);var q=Math.min(j+t.text.length,c+(g||1000000))-s;s-=j;j+=t.text.length;try{if(q>0&&s>=0){o+=r.getSubStringLength(s,q)}}catch(p){console.warn(p)}});if(k){_txtWidths[k]=o||b.getComputedTextLength()}return o}}else{if(typeof(d)=="object"){if(d.childNodes.length==1){var l=d.firstChild;var k=$(l).attr("class").replace(/(?:^|\s)goudy(?:\s|$)|\s+$/g,"")+","+l.textContent;var f=_txtWidths[k];if(f){return f}}$(b).empty().append($(d).clone());var o=b.getComputedTextLength();if(k){_txtWidths[k]=o}return o}}if(n){b.setAttribute("class",n)}$(b).text(d.replace(/ /g,"\u00a0"));var o=b.getSubStringLength(c,g||d.length);if(k){_txtWidths[k]=o}return o;return o}function useWidth(b,j,h){if(b.tagName.match(/^use$/i)){b=document.getElementById(b.getAttribute("href").slice(1))}if(typeof(j)=="undefined"){return getChantWidth(b.textContent)}else{var c=0;var f="";var d="";var l=[];for(var g=0;g<b.childNodes.length;++g){var k=b.childNodes[g];if(c>=j){if(l.length==0&&getChantWidth(k.textContent)<=2){f=f.slice(0,0-d.length)}else{d=""}l.push(getChantWidth(f));if(l.length==2){return l}f=d;j+=h}f+=k.textContent;d=k.textContent;c+=1}l.push(getChantWidth(f));return l}}function getChantWidth(b){defChant.textContent=b;return defChant.getComputedTextLength()}function selectGabc(g,b){var f=$("#editor");g+=getHeaderLen(f.val());if(f.is(":visible")){f=f[0]}else{f=$("#hymngabc")[0];var d=0,c;for(c in _hymnGabcMap){if(c>g){break}d=_hymnGabcMap[c]+g-c}g=d}f.select(g,b);f.selectionStart=g;f.selectionEnd=g+b}function getTagsFrom(b){var c,d=[];while(c=regexTag.exec(b)){d.push(c[2]);var f=c.index+c[0].length;if(c.index==0){b=b.slice(c[0].length)}else{b=b.slice(0,c.index)+b.slice(f)}}return d}function tagsForText(f,j){if(typeof(f)=="string"){f=[f]}var d=[];var c=f[0];if(!j){j=[]}var g;while(g=regexTag.exec(c)){var h=c.slice(0,g.index);if(h.length>0){d.push(new TagInfo(h,j))}if(g[1]!="/"){if(j.indexOf(g[2])<0){j.push(g[2])}}else{var b=j.indexOf(g[2]);if(b>=0){j.splice(b,1)}}var k=g.index+g[0].length;c=c.slice(k)}f[0]=c;return d}function TagInfo(b,c){this.tags=$.merge([],c||[]);this.text=b.replace(/ /g,"\u00a0")}TagInfo.prototype.span=function(){var b=make("tspan",this.text);b.setAttribute("class","goudy "+this.tags.join(" "));return b};var finishStaff=function(d){var b=d.parentNode;var c=parseInt(d.id.match(/\d+$/)[0]);var j=d.info;var h=j.ltone;var g=j.htone;h=(3-h);h=(h<=0)?0:((h*spaceheight)/2);g=(g-9);g=(g<=0)?0:((g*spaceheight)/2);var k=Math.ceil(0.1*staffheight+fontsize+h+g);j.vOffset=j.y;if(j.txtInitial){j.txtInitial.setAttribute("y",k+j.y)}if(j.txtAnnotation){j.txtAnnotation.setAttribute("y",j.y+Math.ceil(g)-25)}j.eText.setAttribute("y",k);j.eTrans.setAttribute("y",k+fontsize);j.eText.setAttribute("transform","translate("+j.x+","+j.vOffset+")");j.eTrans.setAttribute("transform","translate("+j.x+","+j.vOffset+")");if(b){b.appendChild(j.eText);b.appendChild(j.eTrans)}if(j.eTrans.childNodes.length>0){k+=fontsize}if(g>0){j.vOffset+=g;if(c==0){var f=0;$(d).children("[id^=neume]").each(function(){f=Math.min(f,this.neume.info.mindy)});_heightCorrection=f+g}d.setAttribute("transform","translate("+j.x+", "+(j.y+g)+")")}return k};var trimStaff=function(j,c){var n;var k=$(j).find("use[href=#staff]");if(c){n=c}else{var b=$(j).find("[id^=neume]:last");var l=$(j.parentNode).find("[id^=neumetext]:last");href=b.attr("href");if(href){if(!/\:$/.exec(href)){return}}else{if(!/\|$/.exec(b.text())){return}}var d=/\d+$/.exec(b.prop("id"))[0];var o=/\d+$/.exec(l.prop("id"))[0];if(o>d){return}n=parseFloat(b.attr("x"));var f=b.attr("transform");var g=regexTranslate.exec(f);if(g&&g[1]){n+=parseFloat(g[1])}n+=b[0].neume.wChant}var h="scale("+n+",1)";k.attr("transform",function(q,p){return p.replace(/scale\([^\)]*\)/,h)})};var justifyLine=function(n){var u=2*spaceBetweenNeumes;var d=svgWidth-n.info.x-u;var c,r;var q=n.words;var l=q.length-1;while(l>=0&&!(c&&r)){var s=q[l--];var k=s.length-1;while(k>=0&&!(c&&r)){var v=s[k--];if(!c&&v.tagName.match(/^use|text$/i)&&v.neume){c=v;continue}else{if(!r&&v.tagName.match(/^tspan$/i)){r=v;continue}}}}var g=0;if(c){g=parseFloat($(c).attr("x"));var f=$(c).attr("transform");var h=regexTranslate.exec(f);if(h&&h[1]){g+=parseFloat(h[1])}g+=c.neume.wChant}if(r){var p=parseFloat($(r).attr("x"));p+=textWidth(r)-u;g=Math.max(g,p)}if(g>0){var b=d-g;var o=q.length-1;var t=b/o;if(b>0){while(o>0){q[o].forEach(function(j){if(j.neume){j.neume.justifyOffset=Math.round(b)}if($(j).attr("transform")){$(j).attr("transform",function(x,w){return"translate("+Math.round(b)+") "+(w||"")})}else{$(j).attr("x",function(x,w){return(w?parseFloat(w):0)+Math.round(b)})}});b-=t;--o}}}};var addCustos=function(n,k,d,h){var c=k.info.ftone;var l=neume(indices.custos,c);var o=n.custos;if(o){o.textContent=l;if(n.custosLedger){try{n.removeChild(n.custosLedger);delete n.custosLedger}catch(j){}}}else{o=make("text",l);o.setAttribute("class",defChant.getAttribute("class"));o.setAttribute("y",0)}if(d||typeof(d)=="undefined"){justifyLine(n);d=true}var b=d?svgWidth-n.info.x-(staffheight/15):h;o.setAttribute("x",b);n.appendChild(o);n.custos=k.custos=o;var f=c>10;var g=c<2;if(f||g){n.custosLedger=k.custosLedger=insertLedger(f,n,o,true)}};function relayoutChant(j){var c=svgWidth=$(j.parentNode).width();var W=$(j);var ab=W.children("g");var I=W.find("#commentary");var M=0,U=0;var F=0;var R=0;var l=W.find("#system"+F);var q=l[0];var O;var K;var v;var o;var Q=l[0].info;var H=[];var u,aa;var g;var Y;var V=$(j).find("defs")[0];var n=Q.y;var N;var f=[];var J;var S;var Z=[];var h=[];Q.ltone=3;Q.htone=10;if(I.length){I.attr("x",c-I[0].getComputedTextLength())}while(true){aa=u;g=K;O=ab.find("#neume"+R);K=ab.find("#neumetext"+R);v=ab.find("#neumetrans"+R);u=O[0]?O[0].neume:(K[0]?K[0].neume:{match:{}});delete u.custos;var b=ab.find("#neumemask"+R);o=$.merge($.merge($.merge($.merge($(),O),K),v),b);J=o.toArray();S=O.toArray().concat(b.toArray());var d=false;for(X in u.ledgers){d=true;break}N=u.offset||0;if(o.length==0){break}U+=Math.min(0,N);if(u.wChant>0&&(M<U||!K.length)){M=U}else{if(aa.lastOnLineHyphen){$(aa.lastOnLineHyphen).remove();delete aa.lastOnLineHyphen}}var C=K.length?M+u.wText+Math.max(Math.floor(N),0):C||0;if(u.match[7]&&u.match.index>0){C+=5}var t=M+u.wChant+spaceBetweenNeumes-Math.min(N,0);var p;if(Math.max(C,t)>=c-Q.x-spaceBetweenNeumes){var k=lastClefBeforeNeume(R);var D=k?k.wChant:0;if(g.length&&!aa.lastOnLineHyphen&&!g.text().slice(-1).match(/-|\s/)){aa.lastOnLineHyphen=new TagInfo("-").span();g.append(aa.lastOnLineHyphen)}C-=M;t-=M;M=0;U=D+spaceBetweenNeumes+N;if(u.wChant>0&&M<U){M=U}C+=M;t+=M;++F;if(f.length){Z.push(f);f=[]}q.words=Z;Z=[];h=[];Y=q;trimStaff(q,c-Q.x);var L=finishStaff(q);l=W.find("#system"+F);if(l.length){q=l[0];q.info.htone=10;q.info.ltone=3}else{var s=staffoffset+L+verticalSpace+Q.y;q=addStaff(q.parentNode,0,s,F,null,V);q.info.vOffset=q.info.y;l=$(q)}Q=q.info}f=f.concat(o.toArray());if(O.length){Q.ltone=Math.min(Q.ltone,u.info.ltone);Q.htone=Math.max(Q.htone,u.info.htone);l.append(O);O.attr("x",M);if(u.transform){O.attr("transform",u.transform)}if(Y){addCustos(Y,u);Y=null}}if(K.length){K.attr("x",M);v.attr("x",M);$(Q.eText).append(K);$(Q.eTrans).append(v);var P=h.length-1;if(P<=0){h[0]=S}else{var r=h[0][0];var z=parseFloat(r.getAttribute("x"))+r.neume.wChant;var E=r.getAttribute("transform");if(E){var T=regexTranslate.exec(E);z+=parseFloat(T[1])}var w=M;if(N<0){w-=N}var B=0;for(var X=1;X<=P;++X){B+=h[X][0].neume.wChant}var A=w-z-B;A/=(P+1);var G=z+A;for(var X=1;X<=P;++X){$(h[X]).attr("x",G);G+=A+h[X][0].neume.wChant}h=[S]}}else{if(h.length>0&&!u.info.ftone){h.push(S);if((f.length==1&&f[0]==O[0])||(f.length==2&&f[0]==O[0]&&f[1]==b[0])){Z.push(f);f=[]}}}if(d){processLedger(u,O[0],f)}if(u.match[7]){Z.push(f);f=[]}M=C;U=t;++R}if(q.custos){$(q.custos).remove();q.custos=undefined}if(q.custosLedger){$(q.custosLedger).remove();q.custosLedger=undefined}trimStaff(q,c-Q.x);finishStaff(q);trimStaff(q);while(l.length){++F;l=W.find("#system"+F);l.remove()}j.setAttribute("height",$(j).children("g")[0].getBBox().height+n+_heightCorrection-_defText.getExtentOfChar("q").height)}function getChant(aC,au,aO,az){if(!az){az=[]}var af=aC[0];aC=aC[1];var c=au?(au.parentNode&&au.parentNode.id=="chant-preview"):false;var H=$(au).find("defs")[0];if(!H){H=_defs}var ax;var O=0;var J=0;var g=aO?true:false;if(aO){$(aO).empty()}else{aO=make("g");aO.setAttribute("transform","translate(0,"+staffoffset+")");aO.setAttribute("class","caeciliae")}if(c){_clefs=[];_accidentals=[];_tones=[]}var aF=$(au.parentNode).width();var aD=af["user-notes"];var ao=af.commentary;var aM=0;if(typeof(aD)=="string"&&aD.length>0){var E=make("text",aD);E.setAttribute("id","userNotes");E.setAttribute("class","goudy i");E.setAttribute("y",16-staffoffset);aO.appendChild(E);aM=20}if(typeof(ao)=="string"&&ao.length>0){var E=make("text",ao);E.setAttribute("id","commentary");E.setAttribute("class","goudy i");E.setAttribute("y",16-staffoffset);aO.appendChild(E);E.setAttribute("x",aF-E.getComputedTextLength());aM=20}az[0]=aM;regexOuter.lastIndex=0;var aq=0;var ad=0;var s;var aE;var w=null;var n;var al;var aG;var ay=0;var P=true;var Y;var u=0;var k=[];var ag=[];var L=[];var F,b,aw;var aN=false;var aA;var ai="goudy";var d=[];var K=addStaff(aO,0,aM,u,null,H);var aB=K.info;try{var B=$(au.parentNode).css("padding-left");if(B){aF-=parseFloat(B)}}catch(V){}svgWidth=aF;while(ax=regexOuter.exec(aC)){var T={index:ax.index+ax[1].length,match:ax,ledgers:{},wChant:0,wText:0};var ap=[];if(ax[5]){T.gabc=ax[5];if(T.gabc.indexOf("(")>=0){var o=ax[0].indexOf("(");var aj=T.gabc.match(/ /);var ac=0;if(aj){ac=aj.index}T.gabc=T.gabc.slice(0,ac);if(ac){++ac}regexOuter.lastIndex-=ax[0].length-o-1-ac}T.info=getChantFragment(T.gabc,H);F=T.info.clef||F;if(c){if(T.info.clef){_clefs[O]=aw=T;aw.clefs=[];_accidentals[J]=F.length==3?-1:null}_tones=_tones.concat(T.info.tones)}defChant.textContent=T.info.def.textContent;T.wChant=defChant.getComputedTextLength();if(T.gabc==F){b=T.wChant}}else{T.info={}}if(ag.length>0&&aA&&(aA[7]||aA[8])){k.push(ag);ag=[]}var ah=ax[7]||ax[8];var E=ax[3]||ah;var f=regexSqBrackets.exec(E);if(f){E=E.slice(0,f.index)+E.slice(f.index+f[0].length);f=f[1]}if(ax[3]&&ah){E+=ah}T.txt=E;T.translation=f;var v=0;if(E){if(P&&ax[3]){P=false;if(af["initial-style"]!="0"){var p=E[0];E=E.slice(1);if(E.length==0){E="-"}var U=aB.txtInitial=make("text",p);U.setAttribute("transform","translate(0,"+aB.vOffset+")");U.setAttribute("class","greinitial");aO.appendChild(U);var aa=U.getComputedTextLength();var I=af.annotation;if(typeof(I)=="string"&&I.length>0){var Q=/([a-g]\d?\*?\s*)$/.exec(I);var ar="</sc>";if(Q){I=I.slice(0,Q.index);ar+=Q[0]}I=I.replace(/\b[A-Z\d]+\b/,function(x){return x.toLowerCase()})+ar;var aK=aB.txtAnnotation=make("text");var h=tagsForText("<sc>"+I+"</sc>");for(S in h){aK.appendChild(h[S].span())}aK.setAttribute("class","greannotation");aK.setAttribute("y",aB.vOffset-25);aO.appendChild(aK);var an=aK.getComputedTextLength();var z=Math.max(an,aa)/2;aK.setAttribute("x",z-(an/2));U.setAttribute("x",z-(aa/2));ay=Math.max(an,aa)+5}else{ay=aa+5}aB.eText.setAttribute("transform","translate("+ay+","+aB.vOffset+")");aB.eTrans.setAttribute("transform","translate("+ay+","+aB.vOffset+")");aB.x=ay;var t=$(K).find("use[href=#staff]")[0];t.setAttribute("transform","scale("+(aF-ay)+",1)")}}E=E.replace(/^\s+/,"").replace(/\r\n/g," ").replace(/\n/g," ").replace(/<v>\\greheightstar<\/v>/g,"*").replaceSpTags();var aP=[E];ap=tagsForText(aP,L);E=aP[0];var ae="";if(ap.length>0){ap.forEach(function(x){ae+=x.text})}if(E.length>0){ap.push(new TagInfo(E.replace(/[{}]/g,""),L))}E=ae+E;T.wText=textWidth(ap);if(E){var j=E.indexOf("{"),R=E.indexOf("}"),aQ;if(j>=0&&R>j){var l=E.slice(j+1,R);E=E.slice(0,j)+l+E.slice(R+1);--R;aQ={index:j,"0":l,"1":l}}else{if(/^english$/i.exec(af["centering-scheme"])){aQ={index:0,"0":E.replace(/[,.:;\s]*$/,""),"1":E.replace(/[,.:;\s]*$/,"")}}else{aQ=regexVowel.exec(E)}}if(!aQ){aQ={index:0,"0":E.trimRight(),"1":E.trimRight()}}try{var aL=aQ.index+aQ[0].length-aQ[1].length;v-=textWidth(ap,0,aL);v-=textWidth(ap,aL,aQ[1].length)/2}catch(V){}v+=notewidth/2}}var ab=T.info.startsWithAccidental?getChantWidth("b-"):0;v+=ab;T.offset=v;ad+=Math.min(0,v);if(T.wChant>0&&(aq<ad||!E)){aq=ad}var av=E?aq+T.wText+Math.max(Math.floor(v),0):av||0;if(ax[7]&&ax.index>0){av+=5}var r=aq+T.wChant+spaceBetweenNeumes-Math.min(v,0);var at=T.wText==0?Math.max(at||0,aq):Math.max(av,r);var G;if(al||at>=aF-ay-spaceBetweenNeumes-T.wChant){aN=K;aN.justify=al?al.justify:true;if(!aN.justify){aG=aq}al=undefined;d=[];if(w&&E&&$(w).text().slice(-1)!="-"){w.appendChild(T.lastOnLineHyphen=new TagInfo("-").span())}if(ag.length>0){k.push(ag);ag=[]}K.words=k;k=[];var M=finishStaff(K);var aJ=staffoffset+M+verticalSpace+aB.y;K=addStaff(aO,0,aJ,++u,null,H);K.info.vOffset=K.info.y;aB=K.info;aB.eText.setAttribute("transform","translate(0,"+aB.vOffset+")");aB.eTrans.setAttribute("transform","translate(0,"+aB.vOffset+")");at-=aq;av-=aq;r-=aq;if(F){var s=make("use");s.setAttribute("class","clef");s.setAttributeNS(xlinkns,"href","#"+F);s.setAttribute("x",0);s.setAttribute("y",0);K.appendChild(s);if(aw&&aw.clefs){aw.clefs.push(s)}aq=0;ad=b+spaceBetweenNeumes+v;if(T.wChant>0&&aq<ad){aq=ad}at+=aq;av+=aq;r+=aq}else{aq=0}}al=T.gabc&&T.gabc.match(/z/i);if(al){al.justify=T.gabc.match(/z/)}if(T.gabc){if(aN){addCustos(aN,T,aN.justify,aG);aN=false;ay=0}if(T.info.mask){aE=make("use");aE.setAttributeNS(xlinkns,"href","#"+T.info.mask);aE.setAttribute("id","neumemask"+O);aE.setAttribute("class","caeciliae");aE.setAttribute("x",aq);aE.setAttribute("y",0);ag.push(aE);masks[u].firstChild.appendChild(aE)}else{aE=null}aB.ltone=Math.min(aB.ltone,T.info.ltone);aB.htone=Math.max(aB.htone,T.info.htone);if(c){s=$(T.info.def).clone()[0]}else{s=make("use");s.setAttributeNS(xlinkns,"href","#"+T.gabc)}s.setAttribute("id","neume"+O);s.setAttribute("x",aq);s.setAttribute("y",0);s.neume=T;if(c){J=setUpPunctaIn(s,J);if(ah){var l=F&&F.length==3?-1:null;if(_accidentals[_accidentals.length-1]!=l){_accidentals[J]=l}}}K.appendChild(s);ag.push(s);currentUse=[s];if(aE){currentUse.push(aE)}if(E){var q=d.length-1;if(q<=0){d[0]=currentUse}else{var am=d[0][0];var D=parseFloat(am.getAttribute("x"))+am.neume.wChant;var aI=am.getAttribute("transform");if(aI){var Q=regexTranslate.exec(aI);D+=parseFloat(Q[1])}var C=aq;if(v<0){C-=v}var ak=0;for(var S=1;S<=q;++S){ak+=d[S][0].neume.wChant}var X=C-D-ak;X/=(q+1);var N=D+X;for(var S=1;S<=q;++S){$(d[S]).attr("x",N);N+=X+d[S][0].neume.wChant}d=[currentUse]}}else{if(d.length>0&&!T.info.ftone){d.push(currentUse);if((ag.length==1&&ag[0]==s)||(ag.length==2&&ag[0]==aE&&ag[1]==s)){k.push(ag);ag=[]}}}}else{s=aE=null}if(E){Y=w;pneume=n;w=make("tspan");n=T;var aH=aq;if(s){T.transform="translate("+(-v)+")";if(v>0){if(aH-v>=ad){T.wText-=v;s.setAttribute("transform",T.transform);if(aE){aE.setAttribute("transform",T.transform)}}else{aH+=v;T.wText+=v}}else{s.setAttribute("transform",T.transform);if(aE){aE.setAttribute("transform",T.transform)}}}if(Y){var W=parseFloat(Y.getAttribute("x"),10);var aR=W+textWidth(Y);if(aR<aH){if($(Y).text().slice(-1)!="-"){Y.appendChild(new TagInfo("-").span());pneume.wText=textWidth(Y);aR=W+pneume.wText;if(aR>aH){var A=aR-aH;aH=aR;if(s){s.setAttribute("x",aq+A);if(aE){aE.setAttribute("x",aq+A)}}av+=A;r+=A}}}}w.setAttribute("id","neumetext"+O);w.setAttribute("x",aH);w.setAttribute("class",ai);w.neume=T;aq=av;ad=r;ap.forEach(function(x){w.appendChild(x.span())});if(f){var Z=new TagInfo(f,["i","trans"]).span();Z.setAttribute("id","neumetrans"+O);Z.setAttribute("x",aH);ag.push(Z);aB.eTrans.appendChild(Z)}ag.push(w);aB.eText.appendChild(w)}else{if(s){ad=aq+getChantWidth(T.info.def.textContent)+spaceBetweenNeumes;aq=av}else{ad=aq}}O++;aA=ax;if(ah){w=null}processLedger(T,s,ag)}finishStaff(K);if(gabcSettings.trimStaff){trimStaff(K)}return aO}var boolArray=[true,false];function processLedger(f,c,d){for(i in f.ledgers){$(f.ledgers[i]).remove()}f.ledgers={};if(f.info.ledgerA&&(f.info.ledgerA.length||f.info.ledgerB.length)&&c){var b=c.parentNode;var g=[];processLedgerHelper(f.info.ledgerA,g,true);processLedgerHelper(f.info.ledgerB,g,false);g.forEach(function(h){var j=insertLedger(h,b,c);f.ledgers[h.above]=j;if(d){d.push(j)}})}}function processLedgerHelper(d,h,c){var b=null,g=0;for(a in d){var f=d[a];if(f-1==b){++g}else{if(f-2==b){g+=2}else{if(g>0){h.push({i:b,len:g,above:c})}b=f;g=1}}}if(g>0){h.push({i:b,len:g,above:c})}}function insertLedger(l,g,b,f){var j=0,k=1;if(typeof(l)=="object"){j=l.i;k=l.len;l=l.above}var n=make("use");n.setAttributeNS(xlinkns,"href",l?"#ledgera":"#ledgerb");n.setAttribute("y",b.getAttribute("y"));var c=b.getAttribute("transform");var d=parseFloat(b.getAttribute("x"));if(c){while(m=regexTranslateG.exec(c)){d+=parseFloat(m[1])}}var h=useWidth(b,j,k);d+=h[0];h=h[1];if(f){d-=0.25*notewidth;n.setAttribute("transform","translate("+d+") scale("+(h+0.25*notewidth)+",1)")}else{d-=0.75*notewidth;n.setAttribute("transform","translate("+d+") scale("+(h+1.5*notewidth)+",1)")}if(b){g.insertBefore(n,b)}else{g.appendChild(n)}return n}var ToneInfo=function(b){for(i in b){this[i]=b[i]}};(function(){var h,b,c,f,g;getChantFragment=function(n,j){if(abcs[n]!=undefined){return abcs[n]}var E=undefined;if(n.indexOf("r")>-1){E=n.replace(/r/g,"!");getChantFragment(E,j)}b=make("text");g=3;f=0;b.setAttribute("id",n);var K=null,k,L,s,y=n.length,p=0,r=0,q,z,M,F=false,x=0;ledgerA=[],ledgerB=[];c=0;regexInner.lastMatch=0;var v=[];while(q=regexInner.exec(n)){h=[];var t=-1;chant=q[0];regexTones.exec("");var u;while(u=regexTones.exec(chant)){++x;var l=[];if(u[regexTonesSpliceIndex]){var H=u[regexTonesSpliceIndex];var J;while(J=regexToneModifiers.exec(H)){if(J[3]){var D=J[3].match(/0/)?-1:0;var o=J[3].length+D-1;J[3]=J[3].slice(D-1);var C=1;var G=h.length;while(C<=o&&C<=G){var w=h[G-C];if(!w.match[rtg.episema]){w.match[rtg.episema]=J[3];w.episemaLoc=D}++C}}if(J[2]){var o=J[2].length;if(o>1){var w=h[h.length-1];if(!w.match[rtg.dot]){w.match[rtg.dot]="."}}}$.extend(l,J)}}else{l=new Array(regexToneModifiersCount)}var B=u.index;u=u.splice(0,regexTonesSpliceIndex).concat(l.splice(1,l.length-1)).concat(u.splice(1,u.length-1));u.index=B+q.index;if(u[rtg.bracketed]){continue}if(u[rtg.clef]){z=u[rtg.clef];M=(z[0]=="f")?5:1;M+=(parseInt(z.slice(-1))*2)}tone=u[0];if(u[rtg.whitespace]){for(var C=0;C<transforms[0].length;++C){tone=tone.replace(transforms[2][C],transforms[1][C])}var I=make("tspan",tone);I.setAttribute("offset",u.index);I.setAttribute("len",u[0].length);b.appendChild(I);f=Math.max(f,(/[`,]/.exec(u[rtg.whitespace])&&9.5)||0);v.push(I=new ToneInfo({match:[]}))}else{var A=parseInt(u[rtg.tone]||u[rtg.clef].slice(0,1),23)-10;if(u[rtg.tone]&&u[rtg.tone].length==1){g=Math.min(g,A);f=Math.max(f,A);if(K==null&&!u[rtg.accidental]){K=A}}else{f=Math.max(f,(u[rtg.clef]&&(parseInt(u[rtg.clef].slice(-1))*2+2))||0)}if(A>10){ledgerA.push(x-1)}else{if(A<2){ledgerB.push(x-1)}}var I=new ToneInfo({match:u,index:A,relativeTone:t<0?0:A-t,modifiers:u[rtg.noteType],clef:u[rtg.clef],episemaLoc:(u[rtg.episema]&&u[rtg.episema].match(/0/))?-1:0,diamond:u[rtg.toneUpper]?true:false,markings:u[rtg.ictus]||u[rtg.dot]||u[rtg.episema],liq:u[rtg.diminutiveLiquescentia],accidental:u[rtg.accidental]});h.push(I);v.push(I);t=A}}for(var C=0;C<h.length;++C){C=d(C)}}j.appendChild(b);return abcs[n]={ltone:g,htone:f,ftone:K,tones:v,startsWithAccidental:(v.length>0&&v[0].match[rtg.accidental])?true:false,mask:E,clef:z,clefTone:M,mindy:c,ledgerA:ledgerA,ledgerB:ledgerB,def:b}};var d=function(y){var p=function(J,H,I){if(!I){I=H}if(J==-1){F+=neume(indices.episema_below,H);g=Math.min(g,H-1)}else{F+=neume(indices.episema_above,I);f=Math.max(f,I+1)}},j=function(I,H){if(I==1){F+=neume(indices.ictus_above,H);f=Math.max(f,H+1)}else{F+=neume(indices.ictus_below,H);g=Math.min(g,H-1)}},r=function(){var J=make("tspan",F);var I=arguments[0];J.setAttribute("offset",I.match.index);J.setAttribute("len",I.match[0].length);for(var H=1;H<arguments.length;++H){J.setAttribute("len"+H,arguments[H].match[0].length)}if(arguments.length>1){J.setAttribute("count",arguments.length)}b.appendChild(J);F=""},F="",n=1,q=1,k="",G=h[y],v=(h.length>y+1)?h[y+1]:null,D=(h.length>y+2)?h[y+2]:null,s=(h.length>y+3)?h[y+3]:null,w=(y>0)?h[y-1]:null,o=indices.punctum;if(y>0&&G.relativeTone==0){F+="'"}if(G.diamond){o=G.liq?indices.diamond_tilde:indices.diamond;var A=Math.abs(G.relativeTone);if(w&&w.diamond&&(A==2)){F+="'"}if(v&&!v.diamond){k="-"}}else{if(G.clef){var z=[c];b.appendChild(makeClefSpan(G,z));c=z[0];return y}else{if(G.modifiers){if(G.match[rtg.accidental]){if(y==0){startsWithAccidental=true}var B=(G.match[rtg.flat])?"flat":"natural";F+=neume(indices[B],G.index)+"-";r(G);return y}else{if(G.match[rtg.virga]){o=indices.v;q=G.match[rtg.virga].length;k="'"}else{if(G.match[rtg.stropha]){o=indices.s;q=G.match[rtg.stropha].length;k="'"}else{if(indices[G.modifiers[0]]){o=indices[G.modifiers[0]];if(v&&(v.relativeTone>0&&v.relativeTone<=5)&&G.modifiers=="w"&&(!D||D.relativeTone>=0)){F+=neume(o,G.index);if(G.match[rtg.ictus]){j(-1,G.index)}if(G.match[rtg.episema]){p(-1,G.index)}r(G);if(v.relativeTone>1){F+=neume(indices.connecting_line,G.index,v.index)}++y;o=indices.topPartPodatus;G=v;G.episemaLoc=1}}}}}}else{if(v&&!v.diamond&&(!v.modifiers||v.liq)){if(v.relativeTone>0&&v.relativeTone<=5){if(D&&!D.diamond&&(!D.modifiers||D.modifiers=="~")&&D.relativeTone<0&&D.relativeTone>=-4){o=indices.punctum;if(!D.modifiers&&s&&s.relativeTone>=1&&s.relativeTone<=5){--y;G.episemaLoc=0;v.episemaLoc=0}else{F+=neume(o,G.index);var x=v.index;var E=Math.min(G.index,D.index);if(G.match[rtg.episema]){p(G.episemaLoc,E,x)}if(G.match[rtg.ictus]){j(G.episemaLoc,G.index);G.match[rtg.ictus]=undefined}r(G);if(v.relativeTone>1){F+=neume(indices.connecting_line,G.index,v.index)}if(D.modifiers=="~"){--y;o=undefined}else{F+=neume(o,v.index);if(v.match[rtg.episema]){p(G.episemaLoc,E,x)}if(v.match[rtg.ictus]){j(v.episemaLoc,v.index);v.match[rtg.ictus]=undefined}r(v);if(D.relativeTone<-1){F+=neume(indices.connecting_line,D.index,v.index)}G=D;if(D.match[rtg.episema]){G.episemaTone=D.episemaLoc==-1?E:x}if(D.modifiers=="~"){o=indices.lower_tilde}n=3;++y}}}else{if(v.relativeTone<=5){G.episemaLoc=-1;v.episemaLoc=1;o=indices.topPartPodatus;n=2;if(D&&D.relativeTone<=0){k="-"}if(v.liq){F+=neume(indices["<"],G.index);o=indices.upper_tilde}else{F+=neume(indices.bottomPartPodatus,G.index)}r(G);if(v.relativeTone>1){F+=neume(indices.connecting_line,G.index,v.index)}var C=G;G=v;v=C}}++y}else{if(v.relativeTone<0&&v.relativeTone>=-5){if(!G.markings&&D&&!D.diamond&&(!D.modifiers||D.modifiers=="~")&&D.relativeTone>=1&&D.relativeTone<=4&&v.relativeTone>=-4){if(G.relativeTone>=2&&G.relativeTone<=5){F+=neume(indices.connecting_line,G.index-G.relativeTone,G.index)}else{if(G.relativeTone<1){var t=Math.max(-v.relativeTone,1);F+=(b.childNodes.length>0?"-":"")+neume(indices.decorative_line,G.index-t,G.index)}}if(D.modifiers=="~"){--y;F+=neume(o,G.index);r(G);F+=neume(indices.connecting_line,v.index,G.index);o=undefined}else{F+=neume(indices.porrectus,G.index,v.index);r(G,v);F+=neume(indices.decorative_line,v.index,D.index);o=indices.topPartPodatus;D.episeamLoc=1;v.episemaLoc=-1;G=D;n=3;++y}}else{n=2;if(v.liq){var t=Math.min(-v.relativeTone,2);F+=neume(indices.decorative_line,G.index-t,G.index);F+=neume(indices[">"],G.index);r(G);o=indices.lower_tilde}else{if(G.relativeTone>0&&G.relativeTone<=5&&w.modifiers=="w"){if(G.relativeTone>1){F+=neume(indices.connecting_line,w.index,G.index)}}else{F+=neume(indices.decorative_line,v.index,G.index)}F+=neume(indices.punctum,G.index);if(G.match[rtg.episema]){p(G.episemaLoc,v.index,G.index)}if(G.match[rtg.ictus]){j(G.episemaLoc,G.index);G.match[rtg.ictus]=undefined}if(v.match[rtg.episema]){C=v.episemaLoc==-1?E:x;G.episemaTone=1;if(v.episemaLoc!=-1){v.episemaTone=G.index}}if(G.match[rtg.dot]){F+=neume(indices.dot,G.index);G.match[rtg.dot]=undefined}r(G)}if(v.relativeTone<-1){F+=neume(indices.connecting_line,v.index,G.index)}var C=G;G=v;v=C}++y}}}}}}var C=neume(o,G.index);if(q>1){C=(C+"'").repeat(q).slice(0,-1)}F+=C;if(G.match[rtg.ictus]){j(G.episemaLoc,G.index)}if(G.match[rtg.episema]){var C=G.episemaTone||G.index;p(G.episemaLoc,C)}if(n>1){if(v.match[rtg.ictus]){j(v.episemaLoc,v.index)}if(v.match[rtg.episema]&&!G.episemaTone){p(v.episemaLoc,v.index)}}var u,l;if(n>1){u=Math.min(v.index,G.index);l=Math.max(v.index,G.index);if((l-u)>=2||u%2==0){u=undefined}}var C=G.match[rtg.dot];if(C){if(G.index==u){F+=neume(indices.dot,u-1)}else{F+=neume(indices.dot,G.index)}C=C.length}else{C=0}if(v&&(C>1||(n>1&&(C=v.match[rtg.dot])))){if(v.index==u){F+=neume(indices.dot,u-1)}else{F+=neume(indices.dot,v.index)}}if(C&&h[y+1]){k+="--"}F+=k;if(o){r(G)}return y}})();function addStaff(n,l,j,o,q,b){var d="staffmask"+o;var w="staff"+o;var h="system"+o;var c;if(masks[o]){var v=masks[o].firstChild;while(v.childElementCount>1){v.removeChild(v.childNodes[1])}c=v.firstChild}else{var t=masks[o],s,u;if(t&&t.parentNode!=b){t=$(b).find("#"+d)[0]}if(t){s=t;u=s.firstChild;c=$(u).find(">rect")[0]}else{s=make("mask");s.setAttribute("maskUnits","objectBoundingBox");s.setAttribute("id",d);u=make("g");u.setAttribute("class","caeciliae");s.appendChild(u);c=make("rect");u.appendChild(c);b.appendChild(s)}masks[o]=s;s.setAttribute("transform","translate(0,"+(j)+")")}c.setAttribute("y",-staffheight);c.setAttribute("width","10000");c.setAttribute("height",1+staffheight);c.setAttribute("fill","white");var r=make("g");var p=r.info={ltone:3,htone:10,vOffset:0,x:0,y:parseInt(j),eText:make("text"),eTrans:make("text")};p.eText.setAttribute("class","goudy");p.eTrans.setAttribute("class","goudy");var f=make("g");r.setAttribute("id",h);f.setAttribute("id",w);f.setAttribute("mask","url(#"+d+")");var k=make("use");k.setAttributeNS(xlinkns,"href","#staff");if(!q){q=$(svg.parentNode).width()}k.setAttribute("transform","translate("+(l)+") scale("+(q)+",1)");f.appendChild(k);r.appendChild(f);n.appendChild(r);return r}var gradients={};function setGradient(l,d){var j=d==0?"RedBlack":"BlackRed",b=l.parentNode,f=[],p=$(l).index(),g,o=useWidth(b,p,1),h=b.neume.wChant||useWidth(b),c="grad"+j+o.join("_")+"_"+h;if(!(c in gradients)){var k=$(gradients[j]).clone(),n=k.find("stop");k.attr("id",c);$(n[0]).attr("offset",(o[0]+(0.25*o[1]))/h);$(n[1]).attr("offset",(o[0]+(0.75*o[1]))/h);_defs.appendChild(k[0]);gradients[c]=k[0]}l.setAttribute("style","fill:url(#"+c+")")}function setUpPunctaIn(b,c){var g=0,d=c,f=b.neume.info.tones;$(b).children().each(function(){var j=f[g];if(j.match[rtg.accidental]){_accidentals[c]=j.match[rtg.flat]?(j.index-_clefs[_clefs.length-1].info.clefTone):null}this.setAttribute("id","punctum"+c);var h=parseInt(this.getAttribute("count"))||1;if(h==2){if(c==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected-1");setGradient(this,0)}else{if(c+1==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected-2");setGradient(this,1)}else{this.setAttribute("class","selectable")}}}else{if(c==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected")}else{this.setAttribute("class","selectable")}}g+=parseInt(this.getAttribute("count"))||1;c=d+g});return c}var playTone=function(){console.warn("Audiolet library not loaded.")};var playScore=playTone;var stopScore=playTone;var baseFreq=385;$(function(){var L=function(){var O=new Audiolet(baseFreq*4,2,baseFreq);var S=function(U,T){AudioletGroup.apply(this,[O,0,1]);this.sine=new Sine(O,U);this.gain=new Gain(O);this.env=new PercussiveEnvelope(O,1,0.3,(T||1)*0.3,function(){this.audiolet.scheduler.addRelative(0,this.remove.bind(this))}.bind(this));this.envMulAdd=new Multiply(O,0.2,0);this.sine.connect(this.gain);this.gain.connect(this.outputs[0]);this.env.connect(this.envMulAdd);this.envMulAdd.connect(this.gain,0,1)};extend(S,AudioletGroup);var P=function(V,U){var T=new S(V,U);T.connect(O.output)};var R={0:0,1:2,2:4,3:5,4:7,5:9,6:11};playTone=function(W,T,V){var U=baseFreq;T=W==T;while(W<0){W+=7,U/=2}while(W>=7){W-=7,U*=2}if(W>0){U*=Math.pow(2,(R[W]-(T?1:0))/12)}P(U,V)};var Q=false;tempo=150;var s;playScore=function(U){var T=U?0:(selectedPunctum||0);while(s&&s.next()){}s=new PSequence(_tones,1,T);Q=true;O.scheduler.setTempo(tempo);O.scheduler.play([s],1,function(V){var W;while(!(Q=Q&&T<_tones.length)||!(W=V.play(T))){++T;if(!(V=s.next())){q(-1);Q=false;return}}q(T,true);if(W){O.scheduler.setTempo(tempo/W)}++T})};stopScore=function(){Q=false}};var d=function(){if(typeof(Audiolet)=="function"){try{L()}catch(s){}}else{$.getScript("audiolet.js",L)}};if(typeof(Sink)=="function"){d()}else{$.getScript("sink.js",d)}if($("link[href=style\\.css]").length==0){$(document.head).append($('<link rel="stylesheet" type="text/css" href="style.css">'))}var H=$("#tbl");if(H){for(var b=57568;b<65535;b+=16){var l=document.createElement("row");var h=document.createElement("td");var f=document.createElement("td");h.innerText="0x"+b.toString(16);var x="";for(var F=0;F<16;++F){x+=String.fromCharCode(b+F)+"_"}f.innerText=x;f.className="caeciliae";l.appendChild(h);l.appendChild(f);H.append(l)}}svg=document.createElementNS(svgns,"svg");svg.setAttribute("style","width:100%");setPrintFont=function(s){$(svg).find(".caeciliae,.caeciliae-print").attr("class",s?"caeciliae-print":"caeciliae")};_defs=document.createElementNS(svgns,"defs");defText=make("text","");defText.setAttribute("class","goudy");_defs.appendChild(defText);_defText=make("text","");_defText.setAttribute("class","goudy");_defs.appendChild(_defText);defChant=make("text","p");defChant.setAttribute("class","caeciliae");_defs.appendChild(defChant);defChantSvg=make("text","p");defChantSvg.setAttribute("class","caeciliaeSvg");_defs.appendChild(defChantSvg);var I=make("linearGradient");I.setAttribute("gradientUnits","objectBoundingBox");I.setAttribute("id","gradRedBlack");var z=make("stop");z.setAttribute("offset","0");z.setAttribute("stop-color","#e22");I.appendChild(z);z=make("stop");z.setAttribute("offset","100");z.setAttribute("stop-color","#000");I.appendChild(z);gradients.RedBlack=I;I=make("linearGradient");I.setAttribute("gradientUnits","objectBoundingBox");I.setAttribute("id","gradBlackRed");var z=make("stop");z.setAttribute("offset","0");z.setAttribute("stop-color","#000");I.appendChild(z);z=make("stop");z.setAttribute("offset","100");z.setAttribute("stop-color","#e22");I.appendChild(z);gradients.BlackRed=I;var k;if(staffInFont){k=document.createElementNS(svgns,"text");k.textContent="'";k.setAttribute("transform","scale(0.5,1)")}else{k=document.createElementNS(svgns,"g");var y=1;var u=document.createElementNS(svgns,"path");var C="h1v"+y+"h-1zm0 -"+spaceheight;u.setAttribute("d","M0 0"+C.repeat(4));k.appendChild(u);var r=document.createElementNS(svgns,"g");u=document.createElementNS(svgns,"path");u.setAttribute("d","M0 "+spaceheight+C);r.appendChild(u);r.setAttribute("id","ledgerb");_defs.appendChild(r);r=document.createElementNS(svgns,"g");u=document.createElementNS(svgns,"path");u.setAttribute("d","M0 "+(-spaceheight*4)+C);r.appendChild(u);r.setAttribute("id","ledgera");_defs.appendChild(r)}k.setAttribute("id","staff");_defs.appendChild(k);svg.appendChild(_defs);textElem=document.createElementNS(svgns,"g");textElem.setAttribute("transform","translate(0,"+staffoffset+")");textElem.setAttribute("class","caeciliae");svg.appendChild(textElem);var n=$("#chant-preview");if(n.length==0){$(document.body).append(svg)}else{n.append(svg);lastClefBeforeNeume=function(P){var O,s={clefTone:9};for(O in _clefs){if(O<P){s=_clefs[O]}else{break}}return s};lastClefBeforePunctum=function(P){var Q,s={clefTone:9};for(Q in _clefs){try{var O=parseInt($(svg).find("#neume"+Q).children()[0].id.match(/\d+$/)[0]);if(O<P){s=_clefs[Q].info}else{break}}catch(R){}}return s};var w=function(O,Q){var P,s=null;for(P in _accidentals){if(P<=O){s=_accidentals[P]}else{break}}return s};ToneInfo.prototype.play=function(s){var P=lastClefBeforePunctum(s).clefTone;var O=this.match&&(this.match[rtg.dot]||this.match[rtg.episema])?2:1;if(!this.clef&&!this.accidental&&typeof(this.index)=="number"){playTone(this.index-P,w(s),O);return O}return false};var A=function(Q){var am=selectedPunctumTag;if(!am){return}var aj=am.parentNode;var ae=selectedPunctum-/^punctum(\d+)$/.exec(aj.childNodes[0].id)[1];var X=aj.neume;var al=X.info.tones[ae];if(!al||!al.match){return}var ak=al.match[rtg.tone],O,aa;if(!ak){aa=al.match[rtg.clef];ak=parseInt(aa.slice(-1));var O=ak+Q;if(O<1){O=1}else{if(O>4){O=4}}Q=O-ak;if(Q==0){return}aa=aa.slice(0,-1)+O}else{var P=al.index+Q;if(P<0){P=0}else{if(P>12){P=12}}Q=P-al.index;if(Q==0){return}O=String.fromCharCode(ak.charCodeAt(0)+Q)}e=$("#editor");var Y=e.val();var R=getHeaderLen(Y);R+=X.index;var ai=Y.slice(0,R);Y=Y.slice(R);R=t(true);var Z=R+al.match[0].length;var ac=Y.slice(0,R);ac+=Y.slice(R,Z).replace(ak,O);R=X.gabc.length;ac+=Y.slice(Z,R);Y=ai+ac+Y.slice(R);X.gabc=ac;var ag=X.info;var S=X.info=getChantFragment(ac,$(svg).find("defs")[0]);if(aa){for(ad in _clefs[selectedNeume].clefs){var ah=_clefs[selectedNeume].clefs[ad];ah.setAttributeNS(xlinkns,"href","#"+aa)}}stopScore();S.tones[ae].play(selectedPunctum);var ab=$(S.def).clone()[0];ab.neume=X;ab.setAttribute("id",aj.id);ab.setAttribute("x",aj.getAttribute("x"));ab.setAttribute("y",aj.getAttribute("y"));ab.setAttribute("transform",aj.getAttribute("transform"));$(aj).replaceWith(ab);X.wChant=useWidth(ab);processLedger(X,ab);relayoutChant(svg);if(ae==0&&X.custos){addCustos(X.custos.parentNode,X)}var U=ab.parentNode;var s=U.info.htone;var V=U.info.ltone;if(ag.htone<=X.info.htone){U.info.htone=Math.max(U.info.htone,X.info.htone)}else{U.info.htone=10;$(U).find("[id^=neume]").each(function(){U.info.htone=Math.max(U.info.htone,this.neume.info.htone)})}if(ag.ltone>=X.info.ltone){U.info.ltone=Math.min(U.info.ltone,X.info.ltone)}else{U.info.ltone=3;$(U).find("[id^=neume]").each(function(){U.info.ltone=Math.min(U.info.ltone,this.neume.info.ltone)})}var W=$(U.parentNode).children("#system0")[0].info.y;if(aa||s!=U.info.htone||V!=U.info.ltone){var T=finishStaff(U);var af=staffoffset+T+verticalSpace+U.info.y;var ad=parseInt(U.id.match(/\d+$/)[0])+1;while((U=$(U).siblings("#system"+ad)[0])){U.info.y=af;T=finishStaff(U);af=staffoffset+T+verticalSpace+U.info.y;++ad}}svg.setAttribute("height",$(svg).children("g")[0].getBBox().height+W+_heightCorrection-_defText.getExtentOfChar("q").height);ae=selectedPunctum-ae;selectedPunctumTag=null;ae=setUpPunctaIn(ab,ae);selectedNeumeTag=ab;e.val(Y)};var t=function(R){if(!(selectedPunctum!=null&&selectedPunctumTag)){return}var O=selectedPunctumTag;var Q=selectedPunctum-O.id.match(/^punctum(\d+)$/)[1];var P=O.parentNode;var S=parseInt(O.getAttribute("offset"))||0;var s=parseInt(O.getAttribute("len"))||3;if(Q){S+=s;s=parseInt(O.getAttribute("len1"))}if(R){return S}selectGabc(P.neume.index+S,s)};var q=function(O,s){O=parseInt(O);if(O<0){O=-1}if(O==selectedPunctum){return}var S=0,R;if(O<0){s=true;R=$()}else{R=$(svg).find("#punctum"+O);if(R.length==0){S=1;--O;R=$(svg).find("#punctum"+O);if(R.length==0||R.attr("count")!=2){selectedPunctumTag=null;return}}}selectedPunctum=O+S;selectedPunctumTag=R[0];var Q=R.parent().attr("id");if(Q){Q=/neume(\d+)/i.exec(Q)}selectedNeume=Q?parseInt(Q[1]):-1;selectedNeumeTag=selectedPunctumTag&&selectedPunctumTag.parentNode;$(svg).find(".selectable").attr({"class":"selectable",style:""});R.attr("class","selectable selected"+(R.attr("count")==2?"-"+(1+S):""));if(R.attr("count")==2){setGradient(R[0],S)}if(!s){stopScore();var P=selectedPunctum-/^punctum(\d+)$/.exec(selectedNeumeTag.childNodes[0].id)[1];selectedNeumeTag.neume.info.tones[P].play(selectedPunctum)}};var K=function(O){var s=$(svg).find("#neume"+O+">tspan");punctumToSelect=/punctum(\d+)/i.exec(s.attr("id"));if(punctumToSelect){q(parseInt(punctumToSelect[1]))}};$("tspan.selectable[id^=punctum]").live("click",function(s){q(/punctum(\d+)/i.exec(this.id)[1])});var c=function(O){if(O.target.tagName.match(/textarea|input|select/i)){q(-1);return}var s=selectedPunctum;if(O.ctrlKey){var P=selectedNeume;switch(O.which){case 37:--P;break;case 39:++P;break;case 38:A(2);O.preventDefault();return;case 40:A(-2);O.preventDefault();return;case 13:J();return;case 32:playScore();return;default:return}K(P)}else{switch(O.which){case 37:--s;break;case 39:++s;break;case 38:A(1);O.preventDefault();return;case 40:A(-1);O.preventDefault();return;case 13:t();O.preventDefault();return;case 32:playScore(true);O.preventDefault();return;case 27:stopScore();return;default:console.info(O.which);return}q(s)}};$(document).keydown(c)}var v=$(".jgabc");v.each(function(s,O){var P=$(O).clone().toggleClass("jgabc jgabc-svg").text("");$(O).hide();$(svg).clone().appendTo(P);$(O).after(P)});var B=null;var p=null;var D=function(P,O){J();if(B){clearTimeout(B)}if(!O){var s=500;B=setTimeout(function(){D(null,true)},s);return}B=null;v.each(function(R,S){var Q=$(S).next(".jgabc-svg").find("svg")[0];if(!Q){return}updateChant(S.innerHTML,Q,true)})};var j=function(O){if(p){clearTimeout(p)}if(!O){var s=500;p=setTimeout(function(){j(true)},s);return}p=null;relayoutChant(svg);v.each(function(Q,R){var P=$(R).next(".jgabc-svg").find("svg")[0];if(!P){return}relayoutChant(P)})};if(navigator.userAgent.match(/\bChrome\b/)){updateAllChantWidth=function(s){j(true)}}else{updateAllChantWidth=function(s){j()}}var J=function(){updateChant($("#editor").val(),svg)};forceUpdateChant=function(){updateChant($("#editor").val(),svg,true)};var o=function(s){s.stopPropagation();s.preventDefault();return false};var G=function(R){R.stopPropagation();R.preventDefault();var Q;for(Q=0;Q<R.originalEvent.dataTransfer.files.length;++Q){var P=R.originalEvent.dataTransfer.files[Q];var s=new FileReader();var O=$(this);s.onload=function(S){O.val(S.target.result).keyup();if(typeof(processGabc)=="function"){processGabc(S.target.result)}};s.readAsText(P)}};$("#editor").keyup(J).bind("dragover",o).bind("drop",G);$(window).resize(updateAllChantWidth);var g=0;var M=0;var N=0;var E=function(){if(svg.parentNode&&svg.parentNode.clientWidth==0){setTimeout(E,100)}else{g=textWidth("abcdefghijklmnopqrstuvwxyz","goudy",true);var O=getChantWidth("4q5P");var s=getChantWidth("P");notewidth=getChantWidth("p");if(O==s){neume=_neumeLig;indices=_indicesLig;makeClefSpan=_clefSpanLig}else{neume=_neumeChar;indices=_indicesChar;makeClefSpan=_clefSpanChar}if(g!=M){_txtWidths={};M=g;forceUpdateChant();D()}if(++N<100){setTimeout(E,300)}}};setTimeout(E,100)});window.updateChant=updateChant;var neume=_neumeChar;var indices=_indicesChar;var makeClefSpan=_clefSpanChar;