String.prototype.repeat=function(b){return new Array(b+1).join(this)};gabcSettings={trimStaff:true};var _indicesChar={flat:[57585,58176,57586,58177,57587,58178,57588,58179,57589,58180,57590,58181,57591],natural:[57593,58182,57594,58183,57595,58184,57596,58185,57597,58186,57598,58187,57599],flat_line:58176,natural_line:58182,punctum:57603,diamond:57619,virga:57635,v:57635,leftVirga:57651,quilisma:57667,w:57667,bottomPartPodatus:57684,topPartPodatus:57699,podatus:[null,57715,57731,57748,57763],o:57779,O:57795,diamond_tilde:57811,">":57827,"<":57843,upper_tilde:57859,lower_tilde:57875,porrectus:[null,57891,57907,57923,57939],r:57971,s:57987,custos:58019,"+":58019,dot:58035,apos:58050,ictus:58050,ictus_above:58053,ictus_below:58050,underscore:58066,episema:58066,episema_below:58066,episema_above:58069,underscore_longer:58082,episema_longer:58082,clivis:[null,58115,58131,58147,58163],accent_above_staff:58188,connecting_line:[undefined,undefined,59139,59155,59171,59187],decorative_line:[undefined,59203,59219,59235,59251,59267]};var _indicesLig={flat:"b",natural:"a",punctum:"p",diamond:"n",virga:"v",v:"v",leftVirga:"c",quilisma:"q",w:"q",podatus:"P",bottomPartPodatus:57684,topPartPodatus:"P",o:"o",O:"O",diamond_tilde:"N",">":"L","<":"k",upper_tilde:"K",lower_tilde:"l",porrectus:"R",r:"w",s:"s",custos:"u","+":"u",dot:".",apos:"I",ictus:"I",ictus_above:"I",ictus_below:"i",underscore:"H",episema:"H",episema_above:"H",episema_below:"h",underscore_longer:58082,episema_longer:58082,clivis:"C",accent_above_staff:"~",connecting_line:"x",decorative_line:"X"};var _neumeLig=function(f,d){if(arguments.length<2){return""}if(typeof(f)!=="string"){if(arguments.length==2&&typeof(f)=="number"){return _neumeChar(f,d)}return""}var c="";var g=1;while(g<arguments.length){c+=_ci[arguments[g++]]}return c+f};var _neumeChar=function(d,c){if(arguments.length<2){return""}var f=d;var d,c;d=parseInt(c);c=0;if(typeof(f)=="object"){if(arguments.length>2){c=parseInt(arguments[2])}f=f[Math.abs(c-d)];if(arguments.length==2){d=0}}return String.fromCharCode(f+d)};var _clefSpanLig=function(f){var c=parseInt(f.clef.slice(-1),10);var d=c*2-1;var b="";if(f.clef.length==3){b+=neume(indices.flat,d+1)+"-"}return make("tspan",String(d)+(f.index==2?"d":"f")+"-"+b)};var _clefSpanChar=function(h,f){var b,d=parseInt(h.clef.slice(-1),10),c=0,g;if(h.index==2){g="d-";c=2-d}else{g="f-";c=3-d}if(h.clef.length==3){g+=neume(indices.flat,4)+"-"}c*=spaceheight;f[0]=Math.min(f[0],c);b=make("tspan",g);b.setAttribute("dy",c);return b};var _ci=["B","A","0","1","2","3","4","5","6","7","8","9","Z"];var staffheight=48;var spaceheight=staffheight/4;var notewidth=staffheight/6;var spaceBetweenNeumes=notewidth;var verticalSpace=staffheight/4;var fontsize=spaceheight*3/2;var spaceWidth=spaceheight*3/4;var staffoffset=Math.ceil(staffheight-spaceheight/2);var svgns="http://www.w3.org/2000/svg";var xlinkns="http://www.w3.org/1999/xlink";var staffInFont=false;var fontExt="ttf";var fontExtS="svg#webfont";var fontFormat="truetype";var fontFormatS="svg";var filenameCaeciliae="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExt;var filenameCaeciliaeS="Caeciliae-"+(staffInFont?"Regular.":"Staffless.")+fontExtS;var filenameCaeciliaePrint="Caeciliae-"+(staffInFont?"Regular":"Staffless")+"-Print."+fontExt;var localCaeciliae="Caeciliae"+(staffInFont?"":" Staffless");var familyCaeciliae="Caeciliae"+(staffInFont?"":" Staffless");var styleCaeciliae="font-family: '"+familyCaeciliae+"'; font-size:"+staffheight+"px;";var styleCaeciliaeSvg="font-family: '"+familyCaeciliae+" SVG'; font-size:"+staffheight+"px;";var styleGoudy="font-family: 'OFL Sorts Mill Goudy TT'; font-size: "+fontsize+"px;";var styleFont="@font-face {font-family: '"+familyCaeciliae+"'; font-weight: normal; font-style: normal;src: local('"+localCaeciliae+"'); src: url('"+filenameCaeciliae+"') format('"+fontFormat+"')}@font-face {font-family: '"+familyCaeciliae+" SVG'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaeS+"') format('"+fontFormatS+"')}@font-face {font-family: '"+familyCaeciliae+" Print'; font-weight: normal; font-style: normal;src: url('"+filenameCaeciliaePrint+"') format('"+fontFormat+"')}@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: italic; font-weight: normal; src: local('OFL Sorts Mill Goudy Italic TT'), local('OFLGoudyStMTT-Italic'), url('OFLGoudyStMTT-Italic.ttf') format('truetype');}@font-face {font-family: 'OFL Sorts Mill Goudy TT'; font-style: normal; font-weight: normal; src: local('OFL Sorts Mill Goudy TT'), local('OFLGoudyStMTT'), url('OFLGoudyStMTT.ttf') format('truetype');}";var svgWidth;var svg;var textElem;var codea="a".charCodeAt(0);var codem=codea+12;var codeA="A".charCodeAt(0);var codeM=codeA+12;var regexTranslate=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/;var regexTranslateG=/translate\((-?\d+(?:\.\d+)?)(?:[,\s]\s*(-?\d+(?:.\d+)?))?\)/g;var regexHeaderEnd=/(?:^|\n)%%\n/;var regexOuter=/((([^\(\r\n]+)($|\())|\()([^\)]*)($|\))(?:(\s+)|(?=(?:\([^\)]*\))+(\s*))|)/g;var regexTag=/<(\/)?(b|i|sc)>/i;var regexSqBrackets=/\[([^\]]*)(?:\]|$)/;var regexTags=/(<(b|i|sc)>)(.*?)(?:(<\/\1>)|$)/i;var regexTagsSp=/<sp>([^<]*)<\/sp>/gi;var spSubstitutions={"'ae":"ǽ","'æ":"ǽ",ae:"æ",oe:"œ","'œ":"œ","'oe":"œ",AE:"Æ",OE:"Œ",Ae:"Æ",Oe:"Œ","V/":"V","R/":"R","A/":"A"};String.prototype.replaceSpTags=function(){return this.replace(regexTagsSp,function(c){var b=c.slice(4,-5);return spSubstitutions[b]||b})};var regexInner=/(?:[!\/ ,;:`]+|[^\)!\/ ,;:`\[]+)(?:\[[^\]]*(?:$|\]))?/g;var rog={syl:3,gabc:5,whitespace:7};var linkSelector="";var linkDownloadSelector="";var setPdfLinkSelector=function(b){linkSelector=b};var onDragStart=function(b){console.info(b);b.originalEvent.dataTransfer.setData("DownloadURL",this.getAttribute("data-downloadurl"))};var setGabcLinkSelector=function(b){linkDownloadSelector=b;$(b).bind("dragstart",onDragStart)};var regexToneModifiers=/(')|(\.{1,2})|(_{1,4}0?)/g;var regexTones=new RegExp("([/ ,;:`]+)|((?:[fF]|[cC][bB]?)[1-4])|(?:(-)?(([A-M])|([a-m]))(([Vv]{1,3})|(s{1,3})|((<)|(>)|(~))|(w)|(o)|(O)|((x)|(y))|(q)|((R)|(r0)|(r(?![1-5])))|(r[1-5])|(\\+))?((?:"+String(regexToneModifiers).replace(/^\/|\/\w*$/g,"").replace(/\((?!\?:)/g,"(?:")+")*)|(z0))|\\[([^\\]]*)(?:\\]|$)","g");var regexTonesSpliceIndex=27;var regexToneModifiersCount=4;var rtg={whitespace:1,clef:2,initioDebilis:3,tone:4,toneUpper:5,toneLower:6,noteType:7,virga:8,stropha:9,liquescentia:10,ascendingLiquescentia:11,descendingLiquescentia:12,diminutiveLiquescentia:13,quilisma:14,oriscus:15,oriscusReverse:16,accidental:17,flat:18,natural:19,q:20,lineaPunctum:22,lineaPunctumCavum:23,punctumCavum:24,rNumber:25,custos:26,ictus:27,dot:28,episema:29,custos:30,bracketed:31};var regexVowel=/(?:[cgq]u|[iy])?([aeiouyáéëíóúýǽæœ]+)/i;var transforms=[["/"," ",",",";",":","`",""],["'","_","+",";","|",",",""],[/\//g,/ /g,/,/g,/;/g,/:/g,/`/g,/!/g]];var abcs={};var _defs=null;var defText=null;var _defText=null;var defChant=null;var masks=[];var selectedPunctum=-1;var selectedNeume=-1;var selectedPunctumTag=null;var selectedNeumeTag=null;var _timeoutGabcUpdate=null;var _minUpdateInterval=1700;var _heightCorrection=0;var _clefs=[];var _accidentals=[];var _tones=[];var utf8_bom=String.fromCharCode(239)+String.fromCharCode(187)+String.fromCharCode(191);function encode_utf8(b){return utf8_bom+unescape(encodeURIComponent(b))}function decode_utf8(b){return decodeURIComponent(escape(b))}function Header(g){this.comments=[];this.original="";var f=g.match(regexHeaderEnd);if(f){var d=this.original=g.slice(0,f.index+f[0].length);var c=d.split(/\r?\n/g);for(i in c){var b=c[i],f=regexHeaderLine.exec(b);if(f){this[f[1]]=f[2]}else{if((f=regexHeaderComment.exec(b))){if(b!="%%"){this.comments[i]=b}}}}}}Header.prototype.toString=function(){var b=[];for(key in this){if(key.length==0||key=="length"||key=="original"||key=="comments"||(typeof this[key])=="function"){continue}b.push(key+": "+this[key]+";")}for(i in this.comments){try{b.splice(i,0,this.comments[i])}catch(c){}}return b.join("\n")+"\n%%\n"};function getHeaderLen(c){var b=c.match(regexHeaderEnd);if(b){return b.index+b[0].length}else{return 0}}var regexHeaderLine=/^([\w-_]+):\s*([^;\r\n]+)(?:;|$)/i;var regexHeaderComment=/^%.*/;function getHeader(b){return new Header(b)}function updateLinks(g){var h=getHeader(g);if(h){g=g.slice(h.original.length)}else{h="%%\n"}if(linkSelector){$(linkSelector).attr("href","http://gregorio.gabrielmass.com/cgi/process.pl?gregtext="+window.escape(h+g)+"&gregfontselect=17&gregtextfontselect=12&greginitialselect=43&gregspaceselect=7mm&gregredselect=N&greglinethickselect=10&gregpaperselect=letterpaper&gregfaceselect=libertine&gregcropselect=N")}try{if(linkDownloadSelector){var d=encode_utf8(h+g);var c="data:text/plain;charset=utf8;base64,"+btoa(d);var b=h.name||"Untitled";if(!b.match(/\.gabc$/)){b+=".gabc"}$(linkDownloadSelector).attr("charset","UTF-8").attr("href",c).attr("data-downloadurl","text/plain:"+b+":"+c)}}catch(f){}return[h,g]}var gabcProcessTime=0;var _nextUpdate=new Date().getTime();function updateChant(l,f,g){if(!l){return}var n=updateLinks(l);if(_timeoutGabcUpdate){clearTimeout(_timeoutGabcUpdate)}if(!g){var d=gabcProcessTime+100;_timeoutGabcUpdate=setTimeout(function(){updateChant(l,f,true)},d);return}_nextUpdate=new Date().getTime()+100+gabcProcessTime;var b=new Date();l=n;_timeoutGabcUpdate=null;var c=$(f).find(">g")[0];if(!c){return}var h=[0];var k=getChant(l,f,c,h);f.setAttribute("height",k.getBBox().height+h[0]+_heightCorrection-_defText.getExtentOfChar("q").height);if(f.parentNode.tagName.match(/span/i)){$(f).css("width",k.getBBox().width)}gabcProcessTime=new Date()-b;console.info("Update chant time: "+gabcProcessTime);if(gabcProcessTime>3000){gabcProcessTime=3000}}function make(c,d){var b=document.createElementNS(svgns,c);if(d){b.appendChild(document.createTextNode(d))}return b}var _txtWidths={};function textWidth(d,o,h){var c=0;var g=undefined;if(d.length===0){return 0}if(typeof(o)=="number"&&typeof(h)=="number"){c=o;g=h;o=h=undefined;if(g===0){return 0}}var b=h?_defText:defText;if($.isArray(d)){var f;var l;if(d.length==1&&d[0].tags.length==0){d=d[0].text;if(o==undefined||o=="goudy"){o=""}if(c==0&&!g&&(l=o+","+d)&&(f=_txtWidths[l])){return f}}else{if(c==0&&!g&&(l=JSON.stringify(d))&&(f=_txtWidths[l])){return f}$(b).empty();var p=0;var k=0;d.forEach(function(u){var s=u.span();b.appendChild(s);var t=Math.max(c,k);var r=Math.min(k+u.text.length,c+(g||1000000))-t;t-=k;k+=u.text.length;try{if(r>0&&t>=0){p+=s.getSubStringLength(t,r)}}catch(q){console.warn(q)}});if(l){_txtWidths[l]=p||b.getComputedTextLength()}return p}}else{if(typeof(d)=="object"){if(d.childNodes.length==1){var n=d.firstChild;var l=$(n).attr("class").replace(/(?:^|\s)goudy(?:\s|$)|\s+$/g,"")+","+n.textContent;var f=_txtWidths[l];if(f){return f}}$(b).empty().append($(d).clone());var p=b.getComputedTextLength();if(l){_txtWidths[l]=p}return p}}if(o){b.setAttribute("class",o)}$(b).text(d.replace(/ /g,"\u00a0"));var p=b.getSubStringLength(c,g||d.length);if(l){_txtWidths[l]=p}return p;return p}function useWidth(b,k,h){if(b.tagName.match(/^use$/i)){b=document.getElementById(b.getAttribute("href").slice(1))}if(typeof(k)=="undefined"){return getChantWidth(b.textContent)}else{var c=0;var f="";var d="";var n=[];for(var g=0;g<b.childNodes.length;++g){var l=b.childNodes[g];if(c>=k){if(n.length==0&&getChantWidth(l.textContent)<=2){f=f.slice(0,0-d.length)}else{d=""}n.push(getChantWidth(f));if(n.length==2){return n}f=d;k+=h}f+=l.textContent;d=l.textContent;c+=1}n.push(getChantWidth(f));return n}}function getChantWidth(b){defChant.textContent=b;return defChant.getComputedTextLength()}function selectGabc(g,b){var f=$("#editor");g+=getHeaderLen(f.val());if(f.is(":visible")){f=f[0]}else{f=$("#hymngabc")[0];var d=0,c;for(c in _hymnGabcMap){if(c>g){break}d=_hymnGabcMap[c]+g-c}g=d}f.select(g,b);f.selectionStart=g;f.selectionEnd=g+b}function getTagsFrom(b){var c,d=[];while(c=regexTag.exec(b)){d.push(c[2]);var f=c.index+c[0].length;if(c.index==0){b=b.slice(c[0].length)}else{b=b.slice(0,c.index)+b.slice(f)}}return d}function tagsForText(f,k){if(typeof(f)=="string"){f=[f]}var d=[];var c=f[0];if(!k){k=[]}var g;while(g=regexTag.exec(c)){var h=c.slice(0,g.index);if(h.length>0){d.push(new TagInfo(h,k))}if(g[1]!="/"){if(k.indexOf(g[2])<0){k.push(g[2])}}else{var b=k.indexOf(g[2]);if(b>=0){k.splice(b,1)}}var l=g.index+g[0].length;c=c.slice(l)}f[0]=c;return d}function TagInfo(b,c){this.tags=$.merge([],c||[]);this.text=b.replace(/ /g,"\u00a0")}TagInfo.prototype.span=function(){var b=make("tspan",this.text);b.setAttribute("class","goudy "+this.tags.join(" "));return b};var finishStaff=function(d){var b=d.parentNode;var c=parseInt(d.id.match(/\d+$/)[0]);var k=d.info;var h=k.ltone;var g=k.htone;h=(3-h);h=(h<=0)?0:((h*spaceheight)/2);g=(g-9);g=(g<=0)?0:((g*spaceheight)/2);var l=Math.ceil(0.1*staffheight+fontsize+h+g);k.vOffset=k.y;if(k.txtInitial){k.txtInitial.setAttribute("y",l+k.y)}if(k.txtAnnotation){k.txtAnnotation.setAttribute("y",k.y+Math.ceil(g)-25)}k.eText.setAttribute("y",l);k.eTrans.setAttribute("y",l+fontsize);k.eText.setAttribute("transform","translate("+k.x+","+k.vOffset+")");k.eTrans.setAttribute("transform","translate("+k.x+","+k.vOffset+")");if(b){b.appendChild(k.eText);b.appendChild(k.eTrans)}if(k.eTrans.childNodes.length>0){l+=fontsize}if(g>0){k.vOffset+=g;if(c==0){var f=0;$(d).children("[id^=neume]").each(function(){f=Math.min(f,this.neume.info.mindy)});_heightCorrection=f+g}d.setAttribute("transform","translate("+k.x+", "+(k.y+g)+")")}return l};var trimStaff=function(k,c){var o;var l=$(k).find("use[href=#staff]");if(c){o=c}else{var b=$(k).find("[id^=neume]:last");var n=$(k.parentNode).find("[id^=neumetext]:last");href=b.attr("href");if(href){if(!/\:$/.exec(href)){return}}else{if(!/\|$/.exec(b.text())){return}}var d=/\d+$/.exec(b.prop("id"))[0];var p=/\d+$/.exec(n.prop("id"))[0];if(p>d){return}o=parseFloat(b.attr("x"));var f=b.attr("transform");var g=regexTranslate.exec(f);if(g&&g[1]){o+=parseFloat(g[1])}o+=b[0].neume.wChant}var h="scale("+o+",1)";l.attr("transform",function(r,q){return q.replace(/scale\([^\)]*\)/,h)})};var justifyLine=function(k,f,g){var p=0;var t=0;var l=k.words;if(!g){var n=2*spaceBetweenNeumes;t=svgWidth-k.info.x-n;var d,u;var r=l.length-1;while(r>=0&&!(d&&u)){var c=l[r--];var q=c.length-1;while(q>=0&&!(d&&u)){var x=c[q--];if(!d&&x.tagName.match(/^use|text$/i)&&x.neume){d=x;continue}else{if(!u&&x.tagName.match(/^tspan$/i)){u=x;continue}}}}if(d){if(f){p=d.neume.x+(d.neume.transformX||0)}else{p=parseFloat($(d).attr("x"));var h=f?d.neume.transform:$(d).attr("transform");var o=regexTranslate.exec(h);if(o&&o[1]){p+=parseFloat(o[1])}}p+=d.neume.wChant}if(u){var v;if(f&&u.neume){v=u.neume.x}else{v=parseFloat($(u).attr("x"));v+=textWidth(u)-n}p=Math.max(p,v)}}if(g||p>0){var b=t-p;var s=l.length-1;var w=b/s;if(g||b>0){while(s>=0){l[s].forEach(function(y){if(y.neume){y.neume.justifyOffset=Math.round(b)}if($(y).attr("transform")){if(f&&y.neume){$(y).attr("x",y.neume.x)}$(y).attr("transform",function(A,z){return"translate("+Math.round(b+(y.neume&&y.neume.transformX||0))+")"})}else{$(y).attr("x",function(A,z){return(f?y.neume.x:(z?parseFloat(z):0))+Math.round(b)})}});b-=w;--s}}}};var addCustos=function(o,l,d,h){var c=l.info.ftone;var n=neume(indices.custos,c);var p=o.custos;if(p){p.textContent=n;if(o.custosLedger){try{o.removeChild(o.custosLedger);delete o.custosLedger}catch(k){}}}else{p=make("text",n);p.setAttribute("class",defChant.getAttribute("class"));p.setAttribute("y",0)}if(d||typeof(d)=="undefined"){justifyLine(o,typeof(l.x)!="undefined");d=true}var b=d?svgWidth-o.info.x-(staffheight/15):h;p.setAttribute("x",b);o.appendChild(p);o.custos=l.custos=p;var f=c>10;var g=c<2;if(f||g){o.custosLedger=l.custosLedger=insertLedger(f,o,p,true)}};function relayoutChant(h){var c=svgWidth=$(h.parentNode).width(),U=$(h),Z=U.children("g"),H=U.find("#commentary"),L=0,S=0,F=0,Q=0,l=U.find("#system"+F),q=l[0],N,J,v,o,P=l[0].info,u,Y,g,W,T=U.find("defs")[0],n=P.y,M,f=[],I,R,X=[],E=c-P.x-spaceBetweenNeumes;tagsBetweenText=[];P.ltone=3;P.htone=10;if(H.length){H.attr("x",c-H[0].getComputedTextLength())}while(true){Y=u;g=J;N=Z.find("#neume"+Q);J=Z.find("#neumetext"+Q);v=Z.find("#neumetrans"+Q);u=N[0]?N[0].neume:(J[0]?J[0].neume:{match:{}});delete u.custos;var b=Z.find("#neumemask"+Q);o=$.merge($.merge($.merge($.merge($(),N),J),v),b);I=o.toArray();R=N.toArray().concat(b.toArray());var d=false;for(V in u.ledgers){d=true;break}M=u.offset||0;if(o.length==0){break}S+=Math.min(0,M);if(u.wChant>0&&(L<S||!J.length)){L=S}else{if(Y.lastOnLineHyphen){$(Y.lastOnLineHyphen).remove();delete Y.lastOnLineHyphen}}var C=J.length?L+u.wText+Math.max(Math.floor(M),0):C||0;if(u.match[7]&&u.match.index>0){C+=5}var t=L+u.wChant+spaceBetweenNeumes-Math.min(M,0);var p;u.x=L;if(Math.max(C,t)>E){var k=lastClefBeforeNeume(Q);var D=k?k.wChant:0;if(g.length&&!Y.lastOnLineHyphen&&!g.text().slice(-1).match(/-|\s/)){Y.lastOnLineHyphen=new TagInfo("-").span();g.append(Y.lastOnLineHyphen)}C-=L;t-=L;L=0;S=D+spaceBetweenNeumes+M;if(u.wChant>0&&L<S){L=S}C+=L;t+=L;u.x=L;++F;if(f.length){X.push(f);f=[]}q.words=X;X=[];tagsBetweenText=[];W=q;trimStaff(q,c-P.x);var K=finishStaff(q);l=U.find("#system"+F);if(l.length){q=l[0];q.info.htone=10;q.info.ltone=3}else{var s=staffoffset+K+verticalSpace+P.y;q=addStaff(q.parentNode,0,s,F,null,T);q.info.vOffset=q.info.y;l=$(q)}P=q.info;E=c-P.x-spaceBetweenNeumes}f=f.concat(o.toArray());if(N.length){P.ltone=Math.min(P.ltone,u.info.ltone);P.htone=Math.max(P.htone,u.info.htone);l.append(N);if(W){addCustos(W,u);W=null}}if(v.length){v[0].neume=u}if(J.length){$(P.eText).append(J);$(P.eTrans).append(v);var O=tagsBetweenText.length-1;if(O<=0){tagsBetweenText[0]=R}else{var r=tagsBetweenText[0][0];var z=r.neume.x+r.neume.wChant;z+=(u.transformX||0);var w=L;if(M<0){w-=M}var B=0;for(var V=1;V<=O;++V){B+=tagsBetweenText[V][0].neume.wChant}var A=w-z-B;A/=(O+1);var G=z+A;for(var V=1;V<=O;++V){for(j in tagsBetweenText[V]){tagsBetweenText[V][j].neume.x=G}G+=A+tagsBetweenText[V][0].neume.wChant}tagsBetweenText=[R]}}else{if(tagsBetweenText.length>0&&!u.info.ftone){tagsBetweenText.push(R);if((f.length==1&&f[0]==N[0])||(f.length==2&&f[0]==N[0]&&f[1]==b[0])){X.push(f);f=[]}}}if(d){processLedger(u,N[0],f)}if(u.match[7]){X.push(f);f=[]}L=C;S=t;++Q}if(f.length){X.push(f)}q.words=X;justifyLine(q,true,true);if(q.custos){$(q.custos).remove();q.custos=undefined}if(q.custosLedger){$(q.custosLedger).remove();q.custosLedger=undefined}trimStaff(q,c-P.x);finishStaff(q);trimStaff(q);while(l.length){++F;l=U.find("#system"+F);l.remove()}h.setAttribute("height",$(h).children("g")[0].getBBox().height+n+_heightCorrection-_defText.getExtentOfChar("q").height)}function getChant(aD,av,aP,aA){if(!aA){aA=[]}var ag=aD[0];aD=aD[1];var R=aD.match(/[\r\n]\s*[-\w]+:[^;]+;\s*[\r\n]/);if(R){aD=aD.slice(0,R.index)}var c=av?(av.parentNode&&av.parentNode.id=="chant-preview"):false;var I=$(av).find("defs")[0];if(!I){I=_defs}var ay;var P=0;var K=0;var g=aP?true:false;if(aP){$(aP).empty()}else{aP=make("g");aP.setAttribute("transform","translate(0,"+staffoffset+")");aP.setAttribute("class","caeciliae")}if(c){_clefs=[];_accidentals=[];_tones=[]}var aG=$(av.parentNode).width();var aE=ag["user-notes"];var ap=ag.commentary;var aN=0;if(typeof(aE)=="string"&&aE.length>0){var F=make("text",aE);F.setAttribute("id","userNotes");F.setAttribute("class","goudy i");F.setAttribute("y",16-staffoffset);aP.appendChild(F);aN=20}if(typeof(ap)=="string"&&ap.length>0){var F=make("text",ap);F.setAttribute("id","commentary");F.setAttribute("class","goudy i");F.setAttribute("y",16-staffoffset);aP.appendChild(F);F.setAttribute("x",aG-F.getComputedTextLength());aN=20}aA[0]=aN;regexOuter.lastIndex=0;var ar=0;var ae=0;var t;var aF;var z=null;var o;var am;var aH;var az=0;var Q=true;var Z;var v=0;var l=[];var ah=[];var M=[];var G,b,ax;var aO=false;var aB;var aj="goudy";var d=[];var L=addStaff(aP,0,aN,v,null,I);var aC=L.info;try{var C=$(av.parentNode).css("padding-left");if(C){aG-=parseFloat(C)}}catch(W){}svgWidth=aG;while(ay=regexOuter.exec(aD)){var U={index:ay.index+ay[1].length,match:ay,ledgers:{},wChant:0,wText:0};var aq=[];if(ay[5]){U.gabc=ay[5];if(U.gabc.indexOf("(")>=0){var p=ay[0].indexOf("(");var ak=U.gabc.match(/ /);var ad=0;if(ak){ad=ak.index}U.gabc=U.gabc.slice(0,ad);if(ad){++ad}regexOuter.lastIndex-=ay[0].length-p-1-ad}U.info=getChantFragment(U.gabc,I);G=U.info.clef||G;if(c){if(U.info.clef){_clefs[P]=ax=U;ax.clefs=[];_accidentals[K]=G.length==3?-1:null}_tones=_tones.concat(U.info.tones)}defChant.textContent=U.info.def.textContent;U.wChant=defChant.getComputedTextLength();if(U.gabc==G){b=U.wChant}}else{U.info={}}if(ah.length>0&&aB&&(aB[7]||aB[8])){l.push(ah);ah=[]}var ai=ay[7]||ay[8];var F=ay[3]||ai;var f=regexSqBrackets.exec(F);if(f){F=F.slice(0,f.index)+F.slice(f.index+f[0].length);f=f[1]}if(ay[3]&&ai){F+=ai}U.txt=F;U.translation=f;var w=0;if(F){if(Q&&ay[3]){Q=false;if(ag["initial-style"]!="0"){var q=F[0];F=F.slice(1);if(F.length==0){F="-"}var V=aC.txtInitial=make("text",q);V.setAttribute("transform","translate(0,"+aC.vOffset+")");V.setAttribute("class","greinitial");aP.appendChild(V);var ab=V.getComputedTextLength();var J=ag.annotation;if(typeof(J)=="string"&&J.length>0){var R=/([a-g]\d?\*?\s*)$/.exec(J);var at="</sc>";if(R){J=J.slice(0,R.index);at+=R[0]}J=J.replace(/\b[A-Z\d]+\b/,function(x){return x.toLowerCase()})+at;var aL=aC.txtAnnotation=make("text");var h=tagsForText("<sc>"+J+"</sc>");for(T in h){aL.appendChild(h[T].span())}aL.setAttribute("class","greannotation");aL.setAttribute("y",aC.vOffset-25);aP.appendChild(aL);var ao=aL.getComputedTextLength();var A=Math.max(ao,ab)/2;aL.setAttribute("x",A-(ao/2));V.setAttribute("x",A-(ab/2));az=Math.max(ao,ab)+5}else{az=ab+5}aC.eText.setAttribute("transform","translate("+az+","+aC.vOffset+")");aC.eTrans.setAttribute("transform","translate("+az+","+aC.vOffset+")");aC.x=az;var u=$(L).find("use[href=#staff]")[0];u.setAttribute("transform","scale("+(aG-az)+",1)")}}F=F.replace(/^\s+/,"").replace(/\r\n/g," ").replace(/\n/g," ").replace(/<v>\\greheightstar<\/v>/g,"*").replaceSpTags();var aQ=[F];aq=tagsForText(aQ,M);F=aQ[0];var af="";if(aq.length>0){aq.forEach(function(x){af+=x.text})}if(F.length>0){aq.push(new TagInfo(F.replace(/[{}]/g,""),M))}F=af+F;U.wText=textWidth(aq);if(F){var k=F.indexOf("{"),S=F.indexOf("}"),aR;if(k>=0&&S>k){var n=F.slice(k+1,S);F=F.slice(0,k)+n+F.slice(S+1);--S;aR={index:k,"0":n,"1":n}}else{if(/^english$/i.exec(ag["centering-scheme"])){aR={index:0,"0":F.replace(/[,.:;\s]*$/,""),"1":F.replace(/[,.:;\s]*$/,"")}}else{aR=regexVowel.exec(F)}}if(!aR){aR={index:0,"0":F.trimRight(),"1":F.trimRight()}}try{var aM=aR.index+aR[0].length-aR[1].length;w-=textWidth(aq,0,aM);w-=textWidth(aq,aM,aR[1].length)/2}catch(W){}w+=notewidth/2}}var ac=U.info.startsWithAccidental?getChantWidth("b-"):0;w+=ac;U.offset=w;ae+=Math.min(0,w);if(U.wChant>0&&(ar<ae||!F)){ar=ae}var aw=F?ar+U.wText+Math.max(Math.floor(w),0):aw||0;if(ay[7]&&ay.index>0){aw+=5}var s=ar+U.wChant+spaceBetweenNeumes-Math.min(w,0);var au=U.wText==0?Math.max(au||0,ar):Math.max(aw,s);var H;if(am||au>=aG-az-spaceBetweenNeumes-U.wChant){aO=L;aO.justify=am?am.justify:true;if(!aO.justify){aH=ar}am=undefined;d=[];if(z&&F&&$(z).text().slice(-1)!="-"){z.appendChild(U.lastOnLineHyphen=new TagInfo("-").span())}if(ah.length>0){l.push(ah);ah=[]}L.words=l;l=[];var N=finishStaff(L);var aK=staffoffset+N+verticalSpace+aC.y;L=addStaff(aP,0,aK,++v,null,I);L.info.vOffset=L.info.y;aC=L.info;aC.eText.setAttribute("transform","translate(0,"+aC.vOffset+")");aC.eTrans.setAttribute("transform","translate(0,"+aC.vOffset+")");au-=ar;aw-=ar;s-=ar;if(G){var t=make("use");t.setAttribute("class","clef");t.setAttributeNS(xlinkns,"href","#"+G);t.setAttribute("x",0);t.setAttribute("y",0);L.appendChild(t);if(ax&&ax.clefs){ax.clefs.push(t)}ar=0;ae=b+spaceBetweenNeumes+w;if(U.wChant>0&&ar<ae){ar=ae}au+=ar;aw+=ar;s+=ar}else{ar=0}}am=U.gabc&&U.gabc.match(/z/i);if(am){am.justify=U.gabc.match(/z/)}if(U.gabc){if(aO){addCustos(aO,U,aO.justify,aH);aO=false;az=0}if(U.info.mask){aF=make("use");aF.setAttributeNS(xlinkns,"href","#"+U.info.mask);aF.setAttribute("id","neumemask"+P);aF.setAttribute("class","caeciliae");aF.setAttribute("x",ar);aF.setAttribute("y",0);ah.push(aF);masks[v].firstChild.appendChild(aF)}else{aF=null}aC.ltone=Math.min(aC.ltone,U.info.ltone);aC.htone=Math.max(aC.htone,U.info.htone);if(c){t=$(U.info.def).clone()[0]}else{t=make("use");t.setAttributeNS(xlinkns,"href","#"+U.gabc)}t.setAttribute("id","neume"+P);t.setAttribute("x",ar);t.setAttribute("y",0);t.neume=U;if(c){K=setUpPunctaIn(t,K);if(ai){var n=G&&G.length==3?-1:null;if(_accidentals[_accidentals.length-1]!=n){_accidentals[K]=n}}}L.appendChild(t);ah.push(t);currentUse=[t];if(aF){currentUse.push(aF)}if(F){var r=d.length-1;if(r<=0){d[0]=currentUse}else{var an=d[0][0];var E=parseFloat(an.getAttribute("x"))+an.neume.wChant;var aJ=an.getAttribute("transform");if(aJ){var R=regexTranslate.exec(aJ);E+=parseFloat(R[1])}var D=ar;if(w<0){D-=w}var al=0;for(var T=1;T<=r;++T){al+=d[T][0].neume.wChant}var Y=D-E-al;Y/=(r+1);var O=E+Y;for(var T=1;T<=r;++T){$(d[T]).attr("x",O);O+=Y+d[T][0].neume.wChant}d=[currentUse]}}else{if(d.length>0&&!U.info.ftone){d.push(currentUse);if((ah.length==1&&ah[0]==t)||(ah.length==2&&ah[0]==aF&&ah[1]==t)){l.push(ah);ah=[]}}}}else{t=aF=null}if(F){Z=z;pneume=o;z=make("tspan");o=U;var aI=ar;if(t){U.transform="translate("+(-w)+")";U.transformX=-w;if(w>0){if(aI-w>=ae){U.wText-=w;t.setAttribute("transform",U.transform);if(aF){aF.setAttribute("transform",U.transform)}}else{aI+=w;U.wText+=w}}else{t.setAttribute("transform",U.transform);if(aF){aF.setAttribute("transform",U.transform)}}}if(Z){var X=parseFloat(Z.getAttribute("x"),10);var aS=X+textWidth(Z);if(aS<aI){if($(Z).text().slice(-1)!="-"){Z.appendChild(new TagInfo("-").span());pneume.wText=textWidth(Z);aS=X+pneume.wText;if(aS>aI){var B=aS-aI;aI=aS;if(t){t.setAttribute("x",ar+B);if(aF){aF.setAttribute("x",ar+B)}}aw+=B;s+=B}}}}z.setAttribute("id","neumetext"+P);z.setAttribute("x",aI);z.setAttribute("class",aj);z.neume=U;ar=aw;ae=s;aq.forEach(function(x){z.appendChild(x.span())});if(f){var aa=new TagInfo(f,["i","trans"]).span();aa.setAttribute("id","neumetrans"+P);aa.setAttribute("x",aI);ah.push(aa);aC.eTrans.appendChild(aa)}ah.push(z);aC.eText.appendChild(z)}else{if(t){ae=ar+getChantWidth(U.info.def.textContent)+spaceBetweenNeumes;ar=aw}else{ae=ar}}P++;aB=ay;if(ai){z=null}processLedger(U,t,ah)}finishStaff(L);if(gabcSettings.trimStaff){trimStaff(L)}return aP}var boolArray=[true,false];function processLedger(f,c,d){for(i in f.ledgers){$(f.ledgers[i]).remove()}f.ledgers={};if(f.info.ledgerA&&(f.info.ledgerA.length||f.info.ledgerB.length)&&c){var b=c.parentNode;var g=[];processLedgerHelper(f.info.ledgerA,g,true);processLedgerHelper(f.info.ledgerB,g,false);g.forEach(function(h){var k=insertLedger(h,b,c);f.ledgers[h.above]=k;if(d){d.push(k)}})}}function processLedgerHelper(d,h,c){var b=null,g=0;for(a in d){var f=d[a];if(f-1==b){++g}else{if(f-2==b){g+=2}else{if(g>0){h.push({i:b,len:g,above:c})}b=f;g=1}}}if(g>0){h.push({i:b,len:g,above:c})}}function insertLedger(n,g,b,f){var k=0,l=1;if(typeof(n)=="object"){k=n.i;l=n.len;n=n.above}var o=make("use");o.setAttributeNS(xlinkns,"href",n?"#ledgera":"#ledgerb");o.setAttribute("y",b.getAttribute("y"));var c=b.getAttribute("transform");var d=parseFloat(b.getAttribute("x"));if(c){while(m=regexTranslateG.exec(c)){d+=parseFloat(m[1])}}var h=useWidth(b,k,l);d+=h[0];h=h[1];if(f){d-=0.25*notewidth;o.setAttribute("transform","translate("+d+") scale("+(h+0.25*notewidth)+",1)")}else{d-=0.75*notewidth;o.setAttribute("transform","translate("+d+") scale("+(h+1.5*notewidth)+",1)")}if(b){g.insertBefore(o,b)}else{g.appendChild(o)}return o}var ToneInfo=function(b){for(i in b){this[i]=b[i]}};(function(){var h,b,c,f,g;getChantFragment=function(o,k){if(abcs[o]!=undefined){return abcs[o]}var F=undefined;if(o.indexOf("r")>-1){F=o.replace(/r/g,"!");getChantFragment(F,k)}b=make("text");g=3;f=0;b.setAttribute("id",o);var L=null,l,M,t,z=o.length,q=0,s=0,r,A,N,G=false,y=0;ledgerA=[],ledgerB=[];c=0;regexInner.lastMatch=0;var w=[];while(r=regexInner.exec(o)){h=[];var u=-1;chant=r[0];regexTones.exec("");var v;while(v=regexTones.exec(chant)){++y;var n=[];if(v[regexTonesSpliceIndex]){var I=v[regexTonesSpliceIndex];var K;while(K=regexToneModifiers.exec(I)){if(K[3]){var E=K[3].match(/0/)?-1:0;var p=K[3].length+E-1;K[3]=K[3].slice(E-1);var D=1;var H=h.length;while(D<=p&&D<=H){var x=h[H-D];if(!x.match[rtg.episema]){x.match[rtg.episema]=K[3];x.episemaLoc=E}++D}}if(K[2]){var p=K[2].length;if(p>1){var x=h[h.length-1];if(!x.match[rtg.dot]){x.match[rtg.dot]="."}}}$.extend(n,K)}}else{n=new Array(regexToneModifiersCount)}var C=v.index;v=v.splice(0,regexTonesSpliceIndex).concat(n.splice(1,n.length-1)).concat(v.splice(1,v.length-1));v.index=C+r.index;if(v[rtg.bracketed]){continue}if(v[rtg.clef]){A=v[rtg.clef];N=(A[0]=="f")?5:1;N+=(parseInt(A.slice(-1))*2)}tone=v[0];if(v[rtg.whitespace]){for(var D=0;D<transforms[0].length;++D){tone=tone.replace(transforms[2][D],transforms[1][D])}var J=make("tspan",tone);J.setAttribute("offset",v.index);J.setAttribute("len",v[0].length);b.appendChild(J);f=Math.max(f,(/[`,]/.exec(v[rtg.whitespace])&&9.5)||0);w.push(J=new ToneInfo({match:[]}));J.match[rtg.whitespace]=v[rtg.whitespace]}else{var B=parseInt(v[rtg.tone]||v[rtg.clef].slice(0,1),23)-10;if(v[rtg.tone]&&v[rtg.tone].length==1){g=Math.min(g,B);f=Math.max(f,B);if(L==null&&!v[rtg.accidental]){L=B}}else{f=Math.max(f,(v[rtg.clef]&&(parseInt(v[rtg.clef].slice(-1))*2+2))||0)}if(B>10){ledgerA.push(y-1)}else{if(B<2){ledgerB.push(y-1)}}var J=new ToneInfo({match:v,index:B,relativeTone:u<0?0:B-u,modifiers:v[rtg.noteType],clef:v[rtg.clef],episemaLoc:(v[rtg.episema]&&v[rtg.episema].match(/0/))?-1:0,diamond:v[rtg.toneUpper]?true:false,markings:v[rtg.ictus]||v[rtg.dot]||v[rtg.episema],liq:v[rtg.diminutiveLiquescentia],accidental:v[rtg.accidental]});h.push(J);w.push(J);u=B}}for(var D=0;D<h.length;++D){D=d(D)}}k.appendChild(b);return abcs[o]={ltone:g,htone:f,ftone:L,tones:w,startsWithAccidental:(w.length>0&&w[0].match[rtg.accidental])?true:false,mask:F,clef:A,clefTone:N,mindy:c,ledgerA:ledgerA,ledgerB:ledgerB,def:b}};var d=function(z){var q=function(K,I,J){if(!J){J=I}if(K==-1){G+=neume(indices.episema_below,I);g=Math.min(g,I-1)}else{G+=neume(indices.episema_above,J);f=Math.max(f,J+1)}},k=function(J,I){if(J==1){G+=neume(indices.ictus_above,I);f=Math.max(f,I+1)}else{G+=neume(indices.ictus_below,I);g=Math.min(g,I-1)}},s=function(K){if(!K||!G||G.length==0){return}var J=make("tspan",G);J.setAttribute("offset",K.match.index);J.setAttribute("len",K.match[0].length);for(var I=1;I<arguments.length;++I){J.setAttribute("len"+I,arguments[I].match[0].length)}if(arguments.length>1){J.setAttribute("count",arguments.length)}b.appendChild(J);G=""},G="",o=1,r=1,l="",H=h[z],w=(h.length>z+1)?h[z+1]:null,E=(h.length>z+2)?h[z+2]:null,t=(h.length>z+3)?h[z+3]:null,x=(z>0)?h[z-1]:null,p=indices.punctum;if(z>0&&H.relativeTone==0){G+="'"}if(H.diamond){p=H.liq?indices.diamond_tilde:indices.diamond;var B=Math.abs(H.relativeTone);if(x&&x.diamond&&(B==2)){G+="'"}if(w&&!w.diamond){l="-"}}else{if(H.clef){var A=[c];b.appendChild(makeClefSpan(H,A));c=A[0];return z}else{if(H.modifiers){if(H.match[rtg.accidental]){if(z==0){startsWithAccidental=true}var C=(H.match[rtg.flat])?"flat":"natural";G+=neume(indices[C],H.index)+"-";s(H);return z}else{if(H.match[rtg.virga]){p=indices.v;r=H.match[rtg.virga].length;l="'"}else{if(H.match[rtg.stropha]){p=indices.s;r=H.match[rtg.stropha].length;l="'"}else{if(indices[H.modifiers[0]]){p=indices[H.modifiers[0]];if(w&&(w.relativeTone>0&&w.relativeTone<=5)&&H.modifiers=="w"&&(!E||E.relativeTone>=0)){G+=neume(p,H.index);if(H.match[rtg.ictus]){k(-1,H.index)}if(H.match[rtg.episema]){q(-1,H.index)}s(H);if(w.relativeTone>1){G+=neume(indices.connecting_line,H.index,w.index)}++z;p=indices.topPartPodatus;H=w;H.episemaLoc=1}}}}}}else{if(w&&!w.diamond&&(!w.modifiers||w.liq)){if(w.relativeTone>0&&w.relativeTone<=5){if(E&&!E.diamond&&(!E.modifiers||E.modifiers=="~")&&E.relativeTone<0&&E.relativeTone>=-4){p=indices.punctum;if(!E.modifiers&&t&&t.relativeTone>=1&&t.relativeTone<=5){--z;H.episemaLoc=0;w.episemaLoc=0}else{G+=neume(p,H.index);var y=w.index;var F=Math.min(H.index,E.index);if(H.match[rtg.episema]){q(H.episemaLoc,F,y)}if(H.match[rtg.ictus]){k(H.episemaLoc,H.index);H.match[rtg.ictus]=undefined}s(H);if(w.relativeTone>1){G+=neume(indices.connecting_line,H.index,w.index)}if(E.modifiers=="~"){--z;p=undefined}else{G+=neume(p,w.index);if(w.match[rtg.episema]){q(H.episemaLoc,F,y)}if(w.match[rtg.ictus]){k(w.episemaLoc,w.index);w.match[rtg.ictus]=undefined}s(w);if(E.relativeTone<-1){G+=neume(indices.connecting_line,E.index,w.index)}H=E;if(E.match[rtg.episema]){H.episemaTone=E.episemaLoc==-1?F:y}if(E.modifiers=="~"){p=indices.lower_tilde}o=3;++z}}}else{if(w.relativeTone<=5){H.episemaLoc=-1;w.episemaLoc=1;p=indices.topPartPodatus;o=2;if(E&&E.relativeTone<=0){l="-"}if(w.liq){G+=neume(indices["<"],H.index);p=indices.upper_tilde}else{G+=neume(indices.bottomPartPodatus,H.index)}s(H);if(w.relativeTone>1){G+=neume(indices.connecting_line,H.index,w.index)}var D=H;H=w;w=D}}++z}else{if(w.relativeTone<0&&w.relativeTone>=-5){if(!H.markings&&E&&!E.diamond&&(!E.modifiers||E.modifiers=="~")&&E.relativeTone>=1&&E.relativeTone<=4&&w.relativeTone>=-4){if(H.relativeTone>=2&&H.relativeTone<=5){G+=neume(indices.connecting_line,H.index-H.relativeTone,H.index)}else{if(H.relativeTone<1){var u=Math.max(-w.relativeTone,1);G+=(b.childNodes.length>0?"-":"")+neume(indices.decorative_line,H.index-u,H.index)}}if(E.modifiers=="~"){--z;G+=neume(p,H.index);s(H);G+=neume(indices.connecting_line,w.index,H.index);p=undefined}else{G+=neume(indices.porrectus,H.index,w.index);s(H,w);G+=neume(indices.decorative_line,w.index,E.index);w.episemaLoc=-1;if(!t||t.relativeTone>=0||t.relativeTone<-5){p=indices.topPartPodatus;E.episeamLoc=1;H=E;o=3;++z}else{p=undefined;E.connectingLine=true;o=2}}}else{o=2;if(w.liq){var u=Math.min(-w.relativeTone,2);G+=neume(indices.decorative_line,H.index-u,H.index);G+=neume(indices[">"],H.index);s(H);p=indices.lower_tilde}else{if(H.relativeTone>0&&H.relativeTone<=5&&(x.modifiers=="w"||H.connectingLine)){if(H.relativeTone>1){G+=neume(indices.connecting_line,x.index,H.index)}}else{G+=neume(indices.decorative_line,w.index,H.index)}G+=neume(indices.punctum,H.index);if(H.match[rtg.episema]){q(H.episemaLoc,w.index,H.index);o=1}if(H.match[rtg.ictus]){k(H.episemaLoc,H.index);H.match[rtg.ictus]=undefined}if(w.match[rtg.episema]){D=w.episemaLoc==-1?F:y;H.episemaTone=1;if(w.episemaLoc!=-1){w.episemaTone=H.index}}if(H.match[rtg.dot]){if(w.match[rtg.dot]){if(w.match[rtg.dot].length==1){w.match[rtg.dot]=".."}}else{G+=neume(indices.dot,H.index);o=1}}s(H)}if(w.relativeTone<-1){G+=neume(indices.connecting_line,w.index,H.index)}var D=H;H=w;w=D}++z}}}}}}var D=neume(p,H.index);if(r>1){D=(D+"'").repeat(r).slice(0,-1)}G+=D;if(H.match[rtg.ictus]){k(H.episemaLoc,H.index)}if(H.match[rtg.episema]){var D=H.episemaTone||H.index;q(H.episemaLoc,D)}if(o>1){if(w.match[rtg.ictus]){k(w.episemaLoc,w.index)}if(w.match[rtg.episema]&&!H.episemaTone){q(w.episemaLoc,w.index)}}var v,n;if(o>1){v=Math.min(w.index,H.index);n=Math.max(w.index,H.index);if((n-v)>=2||v%2==0){v=undefined}}var D=H.match[rtg.dot];if(D){if(H.index==v){G+=neume(indices.dot,v-1)}else{G+=neume(indices.dot,H.index)}D=D.length}else{D=0}if(w&&(D>1||(o>1&&(D=w.match[rtg.dot])))){if(w.index==v){G+=neume(indices.dot,v-1)}else{G+=neume(indices.dot,w.index)}}if(D&&h[z+1]){l+="--"}G+=l;if(p){s(H)}return z}})();function addStaff(o,n,k,p,r,b){var d="staffmask"+p;var z="staff"+p;var h="system"+p;var c;if(masks[p]){var w=masks[p].firstChild;while(w.childElementCount>1){w.removeChild(w.childNodes[1])}c=w.firstChild}else{var u=masks[p],t,v;if(u&&u.parentNode!=b){u=$(b).find("#"+d)[0]}if(u){t=u;v=t.firstChild;c=$(v).find(">rect")[0]}else{t=make("mask");t.setAttribute("maskUnits","objectBoundingBox");t.setAttribute("id",d);v=make("g");v.setAttribute("class","caeciliae");t.appendChild(v);c=make("rect");v.appendChild(c);b.appendChild(t)}masks[p]=t;t.setAttribute("transform","translate(0,"+(k)+")")}c.setAttribute("y",-staffheight);c.setAttribute("width","10000");c.setAttribute("height",1+staffheight);c.setAttribute("fill","white");var s=make("g");var q=s.info={ltone:3,htone:10,vOffset:0,x:0,y:parseInt(k),eText:make("text"),eTrans:make("text")};q.eText.setAttribute("class","goudy");q.eTrans.setAttribute("class","goudy");var f=make("g");s.setAttribute("id",h);f.setAttribute("id",z);f.setAttribute("mask","url(#"+d+")");var l=make("use");l.setAttributeNS(xlinkns,"href","#staff");if(!r){r=$(svg.parentNode).width()}l.setAttribute("transform","translate("+(n)+") scale("+(r)+",1)");f.appendChild(l);s.appendChild(f);o.appendChild(s);return s}var gradients={};function setGradient(n,d){var k=d==0?"RedBlack":"BlackRed",b=n.parentNode,f=[],q=$(n).index(),g,p=useWidth(b,q,1),h=b.neume.wChant||useWidth(b),c="grad"+k+p.join("_")+"_"+h;if(!(c in gradients)){var l=$(gradients[k]).clone(),o=l.find("stop");l.attr("id",c);$(o[0]).attr("offset",(p[0]+(0.25*p[1]))/h);$(o[1]).attr("offset",(p[0]+(0.75*p[1]))/h);_defs.appendChild(l[0]);gradients[c]=l[0]}n.setAttribute("style","fill:url(#"+c+")")}function setUpPunctaIn(b,c){var g=0,d=c,f=b.neume.info.tones;$(b).children().each(function(){var k=f[g];if(k.match[rtg.accidental]){_accidentals[c]=k.match[rtg.flat]?(k.index-_clefs[_clefs.length-1].info.clefTone):null}else{if(k.match[rtg.whitespace]&&k.match[rtg.whitespace].match(/[,;:]/)){_accidentals[c]=_clefs[_clefs.length-1].gabc.length==3?-1:null}}this.setAttribute("id","punctum"+c);this.tone=k;var h=parseInt(this.getAttribute("count"))||1;if(h==2){if(c==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected-1");setGradient(this,0)}else{if(c+1==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected-2");setGradient(this,1)}else{this.setAttribute("class","selectable")}}}else{if(c==selectedPunctum){selectedPunctumTag=this;this.setAttribute("class","selectable selected")}else{this.setAttribute("class","selectable")}}g+=parseInt(this.getAttribute("count"))||1;c=d+g});return c}var playTone=function(){console.warn("Audiolet library not loaded.")};var playScore=playTone;var stopScore=playTone;var baseFreq=385;$(function(){var M=function(){var P=new Audiolet(baseFreq*4,2,baseFreq);var T=function(V,U){AudioletGroup.apply(this,[P,0,1]);this.sine=new Sine(P,V);this.gain=new Gain(P);this.env=new PercussiveEnvelope(P,1,0.3,(U||1)*0.3,function(){this.audiolet.scheduler.addRelative(0,this.remove.bind(this))}.bind(this));this.envMulAdd=new Multiply(P,0.2,0);this.sine.connect(this.gain);this.gain.connect(this.outputs[0]);this.env.connect(this.envMulAdd);this.envMulAdd.connect(this.gain,0,1)};extend(T,AudioletGroup);var Q=function(W,V){var U=new T(W,V);U.connect(P.output)};var S={0:0,1:2,2:4,3:5,4:7,5:9,6:11};playTone=function(X,U,W){var V=baseFreq;U=X==U;while(X<0){X+=7,V/=2}while(X>=7){X-=7,V*=2}if(X>0){V*=Math.pow(2,(S[X]-(U?1:0))/12)}Q(V,W)};var R=false;tempo=150;var s;playScore=function(V){var U=V?0:(selectedPunctum||0);while(s&&s.next()){}s=new PSequence(_tones,1,U);R=true;P.scheduler.setTempo(tempo);P.scheduler.play([s],1,function(W){var X;while(!(R=R&&U<_tones.length)||!(X=W.play(U))){++U;if(!(W=s.next())){r(-1);R=false;return}}r(U,true);if(X){P.scheduler.setTempo(tempo/X)}++U})};stopScore=function(){R=false}};var d=function(){if(typeof(Audiolet)=="function"){try{M()}catch(s){}}else{$.getScript("audiolet.js",M)}};if(typeof(Sink)=="function"){d()}else{$.getScript("sink.js",d)}if($("link[href=style\\.css]").length==0){$(document.head).append($('<link rel="stylesheet" type="text/css" href="style.css">'))}var I=$("#tbl");if(I){for(var b=57568;b<65535;b+=16){var n=document.createElement("row");var h=document.createElement("td");var f=document.createElement("td");h.innerText="0x"+b.toString(16);var y="";for(var G=0;G<16;++G){y+=String.fromCharCode(b+G)+"_"}f.innerText=y;f.className="caeciliae";n.appendChild(h);n.appendChild(f);I.append(n)}}svg=document.createElementNS(svgns,"svg");svg.setAttribute("style","width:100%");setPrintFont=function(s){$(svg).find(".caeciliae,.caeciliae-print").attr("class",s?"caeciliae-print":"caeciliae")};_defs=document.createElementNS(svgns,"defs");defText=make("text","");defText.setAttribute("class","goudy");_defs.appendChild(defText);_defText=make("text","");_defText.setAttribute("class","goudy");_defs.appendChild(_defText);defChant=make("text","p");defChant.setAttribute("class","caeciliae");_defs.appendChild(defChant);defChantSvg=make("text","p");defChantSvg.setAttribute("class","caeciliaeSvg");_defs.appendChild(defChantSvg);var J=make("linearGradient");J.setAttribute("gradientUnits","objectBoundingBox");J.setAttribute("id","gradRedBlack");var A=make("stop");A.setAttribute("offset","0");A.setAttribute("stop-color","#e22");J.appendChild(A);A=make("stop");A.setAttribute("offset","100");A.setAttribute("stop-color","#000");J.appendChild(A);gradients.RedBlack=J;J=make("linearGradient");J.setAttribute("gradientUnits","objectBoundingBox");J.setAttribute("id","gradBlackRed");var A=make("stop");A.setAttribute("offset","0");A.setAttribute("stop-color","#000");J.appendChild(A);A=make("stop");A.setAttribute("offset","100");A.setAttribute("stop-color","#e22");J.appendChild(A);gradients.BlackRed=J;var l;if(staffInFont){l=document.createElementNS(svgns,"text");l.textContent="'";l.setAttribute("transform","scale(0.5,1)")}else{l=document.createElementNS(svgns,"g");var z=1;var v=document.createElementNS(svgns,"path");var D="h1v"+z+"h-1zm0 -"+spaceheight;v.setAttribute("d","M0 0"+D.repeat(4));l.appendChild(v);var t=document.createElementNS(svgns,"g");v=document.createElementNS(svgns,"path");v.setAttribute("d","M0 "+spaceheight+D);t.appendChild(v);t.setAttribute("id","ledgerb");_defs.appendChild(t);t=document.createElementNS(svgns,"g");v=document.createElementNS(svgns,"path");v.setAttribute("d","M0 "+(-spaceheight*4)+D);t.appendChild(v);t.setAttribute("id","ledgera");_defs.appendChild(t)}l.setAttribute("id","staff");_defs.appendChild(l);svg.appendChild(_defs);textElem=document.createElementNS(svgns,"g");textElem.setAttribute("transform","translate(0,"+staffoffset+")");textElem.setAttribute("class","caeciliae");svg.appendChild(textElem);var o=$("#chant-preview");if(o.length==0){$(document.body).append(svg)}else{o.append(svg);lastClefBeforeNeume=function(Q){var P,s={clefTone:9};for(P in _clefs){if(P<Q){s=_clefs[P]}else{break}}return s};lastClefBeforePunctum=function(Q){var R,s={clefTone:9};for(R in _clefs){try{var P=parseInt($(svg).find("#neume"+R).children()[0].id.match(/\d+$/)[0]);if(P<Q){s=_clefs[R].info}else{break}}catch(S){}}return s};var x=function(P,R){var Q,s=null;for(Q in _accidentals){if(Q<=P){s=_accidentals[Q]}else{break}}return s};ToneInfo.prototype.play=function(s){var R=lastClefBeforePunctum(s).clefTone;var Q=this.match&&(this.match[rtg.dot]||this.match[rtg.episema])?2:1;if(Q==1){var P=$("#punctum"+(1+s));if(P.length){P=P[0].tone;if(P&&P.match[rtg.quilisma]){Q=2}}}if(!this.clef&&!this.accidental&&typeof(this.index)=="number"){playTone(this.index-R,x(s),Q);return Q}return false};var B=function(R){var an=selectedPunctumTag;if(!an){return}var ak=an.parentNode;var af=selectedPunctum-/^punctum(\d+)$/.exec(ak.childNodes[0].id)[1];var Y=ak.neume;var am=Y.info.tones[af];if(!am||!am.match){return}var al=am.match[rtg.tone],P,ab;if(!al){ab=am.match[rtg.clef];al=parseInt(ab.slice(-1));var P=al+R;if(P<1){P=1}else{if(P>4){P=4}}R=P-al;if(R==0){return}ab=ab.slice(0,-1)+P}else{var Q=am.index+R;if(Q<0){Q=0}else{if(Q>12){Q=12}}R=Q-am.index;if(R==0){return}P=String.fromCharCode(al.charCodeAt(0)+R)}e=$("#editor");var Z=e.val();var S=getHeaderLen(Z);S+=Y.index;var aj=Z.slice(0,S);Z=Z.slice(S);S=u(true);var aa=S+am.match[0].length;var ad=Z.slice(0,S);ad+=Z.slice(S,aa).replace(al,P);S=Y.gabc.length;ad+=Z.slice(aa,S);Z=aj+ad+Z.slice(S);Y.gabc=ad;var ah=Y.info;var T=Y.info=getChantFragment(ad,$(svg).find("defs")[0]);if(ab){for(ae in _clefs[selectedNeume].clefs){var ai=_clefs[selectedNeume].clefs[ae];ai.setAttributeNS(xlinkns,"href","#"+ab)}}stopScore();T.tones[af].play(selectedPunctum);var ac=$(T.def).clone()[0];ac.neume=Y;ac.setAttribute("id",ak.id);ac.setAttribute("x",ak.getAttribute("x"));ac.setAttribute("y",ak.getAttribute("y"));ac.setAttribute("transform",ak.getAttribute("transform"));$(ak).replaceWith(ac);Y.wChant=useWidth(ac);processLedger(Y,ac);relayoutChant(svg);if(af==0&&Y.custos){addCustos(Y.custos.parentNode,Y)}var V=ac.parentNode;var s=V.info.htone;var W=V.info.ltone;if(ah.htone<=Y.info.htone){V.info.htone=Math.max(V.info.htone,Y.info.htone)}else{V.info.htone=10;$(V).find("[id^=neume]").each(function(){V.info.htone=Math.max(V.info.htone,this.neume.info.htone)})}if(ah.ltone>=Y.info.ltone){V.info.ltone=Math.min(V.info.ltone,Y.info.ltone)}else{V.info.ltone=3;$(V).find("[id^=neume]").each(function(){V.info.ltone=Math.min(V.info.ltone,this.neume.info.ltone)})}var X=$(V.parentNode).children("#system0")[0].info.y;if(ab||s!=V.info.htone||W!=V.info.ltone){var U=finishStaff(V);var ag=staffoffset+U+verticalSpace+V.info.y;var ae=parseInt(V.id.match(/\d+$/)[0])+1;while((V=$(V).siblings("#system"+ae)[0])){V.info.y=ag;U=finishStaff(V);ag=staffoffset+U+verticalSpace+V.info.y;++ae}}svg.setAttribute("height",$(svg).children("g")[0].getBBox().height+X+_heightCorrection-_defText.getExtentOfChar("q").height);af=selectedPunctum-af;selectedPunctumTag=null;af=setUpPunctaIn(ac,af);selectedNeumeTag=ac;e.val(Z)};var u=function(S){if(!(selectedPunctum!=null&&selectedPunctumTag)){return}var P=selectedPunctumTag;var R=selectedPunctum-P.id.match(/^punctum(\d+)$/)[1];var Q=P.parentNode;var T=parseInt(P.getAttribute("offset"))||0;var s=parseInt(P.getAttribute("len"))||3;if(R){T+=s;s=parseInt(P.getAttribute("len1"))}if(S){return T}selectGabc(Q.neume.index+T,s)};var r=function(P,s){P=parseInt(P);if(P<0){P=-1}if(P==selectedPunctum){return}var T=0,S;if(P<0){s=true;S=$()}else{S=$(svg).find("#punctum"+P);if(S.length==0){T=1;--P;S=$(svg).find("#punctum"+P);if(S.length==0||S.attr("count")!=2){selectedPunctumTag=null;return}}}selectedPunctum=P+T;selectedPunctumTag=S[0];var R=S.parent().attr("id");if(R){R=/neume(\d+)/i.exec(R)}selectedNeume=R?parseInt(R[1]):-1;selectedNeumeTag=selectedPunctumTag&&selectedPunctumTag.parentNode;$(svg).find(".selectable").attr({"class":"selectable",style:""});S.attr("class","selectable selected"+(S.attr("count")==2?"-"+(1+T):""));if(S.attr("count")==2){setGradient(S[0],T)}if(!s){stopScore();var Q=selectedPunctum-/^punctum(\d+)$/.exec(selectedNeumeTag.childNodes[0].id)[1];selectedNeumeTag.neume.info.tones[Q].play(selectedPunctum)}};var L=function(P){var s=$(svg).find("#neume"+P+">tspan");punctumToSelect=/punctum(\d+)/i.exec(s.attr("id"));if(punctumToSelect){r(parseInt(punctumToSelect[1]))}};$(document).on("click","tspan.selectable[id^=punctum]",function(s){r(/punctum(\d+)/i.exec(this.id)[1])});var c=function(P){if(P.target.tagName.match(/textarea|input|select/i)){r(-1);return}var s=selectedPunctum;if(P.ctrlKey){var Q=selectedNeume;switch(P.which){case 37:--Q;break;case 39:++Q;break;case 38:B(2);P.preventDefault();return;case 40:B(-2);P.preventDefault();return;case 13:K();return;case 32:playScore();return;default:return}L(Q)}else{switch(P.which){case 37:--s;break;case 39:++s;break;case 38:B(1);P.preventDefault();return;case 40:B(-1);P.preventDefault();return;case 13:u();P.preventDefault();return;case 32:playScore(true);P.preventDefault();return;case 27:stopScore();return;default:console.info(P.which);return}r(s)}};$(document).keydown(c)}var w=$(".jgabc");w.each(function(s,P){var Q=$(P).clone().toggleClass("jgabc jgabc-svg").text("");$(P).hide();$(svg).clone().appendTo(Q);$(P).after(Q)});var C=null;var q=null;var E=function(Q,P){K();if(C){clearTimeout(C)}if(!P){var s=500;C=setTimeout(function(){E(null,true)},s);return}C=null;w.each(function(S,T){var R=$(T).next(".jgabc-svg").find("svg")[0];if(!R){return}updateChant(T.innerHTML,R,true)})};var k=function(P){if(q){clearTimeout(q)}if(!P){var s=500;q=setTimeout(function(){k(true)},s);return}q=null;relayoutChant(svg);w.each(function(R,S){var Q=$(S).next(".jgabc-svg").find("svg")[0];if(!Q){return}relayoutChant(Q)})};if(navigator.userAgent.match(/\bChrome\b/)){updateAllChantWidth=function(s){k(true)}}else{updateAllChantWidth=function(s){k()}}var K=function(){updateChant($("#editor").val(),svg)};forceUpdateChant=function(){updateChant($("#editor").val(),svg,true)};var p=function(s){s.stopPropagation();s.preventDefault();return false};var H=function(S){S.stopPropagation();S.preventDefault();var R;var Q=$(this);for(R=0;R<S.originalEvent.dataTransfer.files.length;++R){var P=S.originalEvent.dataTransfer.files[R];var s=new FileReader();s.onload=function(T){Q.val(T.target.result).keyup();if(typeof(processGabc)=="function"){processGabc(T.target.result)}};s.readAsText(P)}};$("#editor").keyup(K).bind("dragover",p).bind("drop",H);$(window).resize(updateAllChantWidth);var g=0;var N=0;var O=0;var F=function(){if(svg.parentNode&&svg.parentNode.clientWidth==0){setTimeout(F,100)}else{g=textWidth("abcdefghijklmnopqrstuvwxyz","goudy",true);var P=getChantWidth("4q5P");var s=getChantWidth("P");notewidth=getChantWidth("p");if(P==s){neume=_neumeLig;indices=_indicesLig;makeClefSpan=_clefSpanLig}else{neume=_neumeChar;indices=_indicesChar;makeClefSpan=_clefSpanChar}if(g!=N){_txtWidths={};N=g;forceUpdateChant();E()}if(++O<100){setTimeout(F,300)}}};setTimeout(F,100)});window.updateChant=updateChant;var neume=_neumeChar;var indices=_indicesChar;var makeClefSpan=_clefSpanChar;