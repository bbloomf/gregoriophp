<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head><title>GABC Transcription Tool</title>
<link rel="stylesheet" type="text/css" href="style.css?v=1" />
<link href='http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT:400,400italic' rel='stylesheet' type='text/css'>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
<script src="jgabc.js"></script>
<!--<script src="psalmtone.js"></script>-->
</head>
<body class='sans'>
<style>
textarea{
  padding:0px;
}
.tap{
  padding-right:2px;
}
td{
  padding:0px;
}
.trans {font-size:15px;}
</style>
<label for="editor">GABC</label>
&nbsp;&nbsp;<label for="txtWidth">Width</label><input type="text" size="3" id="txtWidth" value="5"/><label for="txtWidth">inches</label>
&nbsp;&nbsp;<input type="checkbox" id="cbCrop" checked /><label for="cbCrop" title="&lt;Ctrl>+R">Crop PDF</label>
&nbsp;&nbsp;<label for="selSpacing">Spacing:</label><select id="selSpacing">
  <option value="">default</option>
  <option value="smith">smith</option>
  <option value="vichi" selected>vichi</option>
</select>
<br><div class="tap"><textarea id="editor" spellcheck="false" style="height: 130pt; width: 100%;">filename:;&#10;user-notes:;&#10;commentary:;&#10;annotation:;&#10;centering-scheme:;&#10;%%&#10;(c4)</textarea></div>
<a href="#" id="lnkDownloadGabc" draggable target="_blank">Download GABC</a>
&nbsp;&nbsp;<a href="#" title="&lt;Ctrl>+S" id="lnkGregorio">Run Gregorio</a>
&nbsp;&nbsp;<a href="#" title="&lt;Ctrl>+&lt;Shift>+S" id="lnkGregorioPDF">Gregorio PDF</a>
<div id="chant-preview" style="width: 100%">
</div>
<form id="imageForm" target="image" method="post" action="http://www.sacredmusicproject.com/gabc/process.php">
<input type="hidden" id="imgf_gabc" name="gabc"/>
<input type="hidden" id="imgf_filename" name="filename"/>
<input type="hidden" id="imgf_width" name="width"/>
<input type="hidden" id="imgf_croppdf" name="croppdf"/>
<input type="hidden" id="imgf_spacing" value="vichi" name="spacing"/>
</form>
<iframe name="image" id="chant-image" frameBorder="0" width="100%" height="600"></iframe>
<form id="pdfForm" target="_blank" method="post" action="http://www.sacredmusicproject.com/gabc/process.php">
<input type="hidden" id="pdff_gabc" name="gabc"/>
<input type="hidden" id="pdff_filename" name="filename"/>
<input type="hidden" id="pdff_width" name="width"/>
<input type="hidden" id="pdff_croppdf" name="croppdf"/>
<input type="hidden" id="pdff_spacing" value="vichi" name="spacing"/>
<input type="hidden" name="fmt" value="pdf"/>
</form>
<script>
var gabcheader={};
function updateBoth(){
  gabcheader=getHeader($("#editor").val());
  updateLocalHeader(gabcheader);
}

function callGregorioPdf(e){
  var filename = gabcheader.filename||"Untitled";
  var gabc = $("#editor").val();
  if(e && typeof(e.preventDefault)=="function"){
    e.preventDefault();
  }
  $("#pdff_gabc").val(gabc);
  $("#pdff_filename").val(filename);
  $("#pdfForm").submit();
}

function callGregorio(e){
  var filename = gabcheader.filename||"Untitled";
  var gabc = $("#editor").val();
  if(e && typeof(e.preventDefault)=="function"){
    e.preventDefault();
  }
  $("#imgf_gabc").val(gabc);
  $("#imgf_filename").val(filename);
  $("#imageForm").submit();
}

function updateLocalHeader(header) {
  localStorage.transcribeHeader=header;
}

function processGabc(gabc){
  var header = getHeader(gabc);
  var filename=(gabcheader && gabcheader.filename)||"Untitled";
  $.post("process.php",{gabc:gabc,filename:filename,croppdf:$("#cbCrop")[0].checked,width:$("#txtWidth").val()},function(e){console.info(filename + " processed");});
}

function docKeyDown(e){
  if(e.ctrlKey) {
    if(e.which==83) {//S
      e.preventDefault();
      if(e.shiftKey){
        callGregorioPdf();
      } else {
        callGregorio();
      }
    } else if(e.which==82){//R
      e.preventDefault();
      var tmp=$("#cbCrop")[0];
      tmp.checked = !tmp.checked;
    }
  }
}

function widthChanged(){
  var val = $("#txtWidth").val();
  $("#imgf_width").val(val);
  $("#pdff_width").val(val);
}

function cropChanged(){
  $("#imgf_croppdf").val(this.checked);
  $("#pdff_croppdf").val(this.checked);
}

function spacingChanged(){
  var val = $("#selSpacing").val();
  $("#imgf_spacing").val(val);
  $("#pdff_spacing").val(val);
}

$(function() {
  $("#lnkGregorio").click(callGregorio);
  $("#lnkGregorioPDF").click(callGregorioPdf);
  $("#txtWidth").keyup(widthChanged);
  $("#cbCrop").change(cropChanged);
  $("#selSpacing").change(spacingChanged);
  $(document).keydown(docKeyDown);
  setPdfLinkSelector("#lnkGabc");
  setGabcLinkSelector("#lnkDownloadGabc");
  $("#editor").keyup(updateBoth).focus();
});
</script>
</body>
</html>
